<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Calculator | Monthly Payment & Interest</title>
    <meta name="description" content="Free Mortgage Calculator. Estimate monthly payments, taxes, PMI & insurance. View amortization schedules and payoff strategies.">
    <meta name="keywords" content="mortgage calculator, home loan, pmi calculator, amortization schedule, interest rate, housing market">
    
    <link rel="canonical" href="https://dailycalc.org/finance/mortgage-calculator.html">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
    
    <!-- Global CSS -->
    <link rel="stylesheet" href="../css/global.css">
    
    <!-- Tailwind & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../js/tailwind-config.js"></script>
    
    <!-- Layout Scripts -->
    <script src="../js/global.js" defer></script>
    <script src="../js/common-layout.js" defer></script>

    <!-- SCHEMA MARKUP (SoftwareApplication) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Mortgage Calculator",
      "url": "https://dailycalc.org/finance/mortgage-calculator.html",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Any",
      "description": "A comprehensive free mortgage calculator that estimates monthly payments including principal, interest, taxes, homeowners insurance, and PMI. Features interactive charts and amortization schedules.",
      "browserRequirements": "Requires JavaScript. Works on all modern browsers.",
      "permissions": "None",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "Monthly Payment Calculation",
        "Amortization Schedule",
        "Extra Payment Estimation",
        "PMI and Tax Inclusion",
        "Interactive Donut Chart"
      ],
      "author": {
        "@type": "Organization",
        "name": "DailyCalc.org"
      }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased">
    
    <div id="header-placeholder" class="no-print"></div>

    <main class="bg-slate-50">
        <div class="mx-auto main-container px-2 py-4 sm:px-4">
            
            <!-- Breadcrumb -->
            <nav class="mb-3 text-xs text-slate-500 no-print" aria-label="Breadcrumb">
                <ol class="flex items-center gap-1">
                    <li><a href="/" class="hover:text-green-700">Home</a></li>
                    <li><span class="text-slate-400">/</span></li>
                    <li><a href="/finance/" class="hover:text-green-700">Finance</a></li>
                    <li><span class="text-slate-400">/</span></li>
                    <li><span class="font-medium text-slate-700">Mortgage Calculator</span></li>
                </ol>
            </nav>

            <!-- PAGE TITLE -->
            <h1 class="mb-6 font-heading text-2xl font-bold text-brand-dark">
                <span class="bg-gradient-to-r from-brand-dark to-brand-red bg-clip-text text-transparent">Mortgage Calculator</span>
            </h1>

            <!-- TOP ROW: CALCULATOR + SIDEBAR -->
            <div class="flex flex-col gap-4 lg:flex-row mb-8">
                
                <!-- LEFT: CALCULATOR CONTAINER (Inputs + Results) -->
                <div class="flex-1 min-w-0">
                    
                    <!-- CALCULATOR HEADER BAR -->
                    <div class="calc-tool-header no-print">
                        <i class="fa-solid fa-circle-arrow-down text-sm opacity-90"></i>
                        <span class="text-xs font-medium">Modify the values and click the Calculate button to use</span>
                    </div>

                    <!-- CALCULATOR CONTENT WRAPPER -->
                    <div class="flex flex-col gap-4 border-x border-b border-slate-300 bg-white p-3 shadow-sm rounded-b-md md:flex-row md:items-start">
                        
                        <!-- COLUMN 1: INPUTS -->
                        <!-- MODIFIED: Changed bg to #EEEEEE (light gray) and updated text/borders for dark-on-light contrast -->
                        <div class="w-full shrink-0 bg-[#EEEEEE] p-4 rounded border border-slate-300 md:w-[280px] print-break-inside-avoid shadow-lg text-slate-900">
                            <form id="mortgageForm">
                                <!-- Inputs -->
                                <div class="input-row mb-3">
                                    <label for="homePrice" class="input-label w-[35%] text-slate-700 font-bold">Home Price</label>
                                    <div class="relative w-[65%]">
                                        <span class="absolute left-2 top-1.5 text-xs text-slate-500 z-10">$</span>
                                        <input type="number" id="homePrice" value="400000" class="compact-input pl-6 bg-white text-slate-900 font-bold border-slate-300 focus:border-brand-red focus:ring-1 focus:ring-brand-red rounded shadow-sm h-8">
                                    </div>
                                </div>
                                
                                <!-- Down Payment -->
                                <div class="input-row mb-3">
                                    <label for="downPaymentInput" class="input-label w-[35%] text-slate-700 font-bold">Down Payment</label>
                                    <div class="flex w-[65%] gap-1">
                                        <div class="relative flex-1">
                                            <input type="number" id="downPaymentInput" value="20" class="compact-input bg-white text-slate-900 font-bold border-slate-300 focus:border-brand-red focus:ring-1 focus:ring-brand-red rounded shadow-sm h-8 w-full">
                                        </div>
                                        <select id="downPaymentType" class="compact-select w-16 px-1 text-center bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-8 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                            <option value="%">%</option>
                                            <option value="$">$</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="input-row mb-3">
                                    <label for="loanTerm" class="input-label w-[35%] text-slate-700 font-bold">Loan Term</label>
                                    <div class="w-[65%] flex items-center gap-2">
                                        <input type="number" id="loanTermInput" value="30" class="compact-input w-full bg-white text-slate-900 font-bold border-slate-300 focus:border-brand-red focus:ring-1 focus:ring-brand-red rounded shadow-sm h-8">
                                        <span class="text-xs text-slate-600 whitespace-nowrap font-medium">years</span>
                                    </div>
                                </div>
                                
                                <div class="input-row mb-3">
                                    <label for="interestRate" class="input-label w-[35%] text-slate-700 font-bold">Interest Rate</label>
                                    <div class="relative w-[65%]">
                                        <input type="number" id="interestRate" value="6.5" step="0.01" class="compact-input pr-6 bg-white text-slate-900 font-bold border-slate-300 focus:border-brand-red focus:ring-1 focus:ring-brand-red rounded shadow-sm h-8">
                                        <span class="absolute right-2 top-1.5 text-xs text-slate-500">%</span>
                                    </div>
                                </div>
                                
                                <div class="input-row mb-4">
                                    <label class="input-label w-[35%] text-slate-700 font-bold">Start Date</label>
                                    <div class="flex w-[65%] gap-1">
                                        <select id="startMonth" class="compact-select w-[50%] bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-8 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                            <option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option>
                                        </select>
                                        <input type="number" id="startYear" class="compact-input w-[50%] bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-8 focus:border-brand-red focus:ring-1 focus:ring-brand-red" placeholder="Year">
                                    </div>
                                </div>
                                
                                <!-- Checkbox -->
                                <div class="mt-2 mb-3 flex items-center justify-end gap-2 border-t border-slate-300 pt-3">
                                    <label for="includeTaxesCosts" class="text-xs font-bold text-slate-800 select-none cursor-pointer hover:text-brand-red transition-colors">Include Taxes & Costs Below</label>
                                    <input type="checkbox" id="includeTaxesCosts" checked class="accent-brand-red h-4 w-4 cursor-pointer rounded border-slate-300 bg-white focus:ring-brand-red">
                                </div>

                                <!-- Standard Costs (Dynamic Inputs) -->
                                <div id="dynamicCostsContainer" class="transition-all duration-300 ease-in-out overflow-hidden">
                                    <!-- Property Tax -->
                                    <div class="input-row mb-2">
                                        <label for="propertyTax" class="input-label w-[35%] text-slate-600 font-semibold">Property Tax</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="propertyTax" value="4800" class="compact-input bg-white w-full text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                            </div>
                                            <select id="propertyTaxType" class="compact-select w-16 px-1 text-center bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                                <option value="$">$</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Home Insurance -->
                                    <div class="input-row mb-2">
                                        <label for="homeInsurance" class="input-label w-[35%] text-slate-600 font-semibold">Home Ins.</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="homeInsurance" value="1500" class="compact-input bg-white w-full text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                            </div>
                                            <select id="homeInsuranceType" class="compact-select w-16 px-1 text-center bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                                <option value="$">$</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- PMI -->
                                    <div class="input-row mb-2">
                                        <label for="pmi" class="input-label w-[35%] text-slate-600 font-semibold">PMI</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="pmi" value="0.5" class="compact-input bg-white w-full text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                            </div>
                                            <select id="pmiType" class="compact-select w-16 px-1 text-center bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                                <option value="%">%</option>
                                                <option value="$">$</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- HOA Fees -->
                                    <div class="input-row mb-2">
                                        <label for="hoaFees" class="input-label w-[35%] text-slate-600 font-semibold">HOA Fee</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="hoaFees" value="0" class="compact-input bg-white w-full text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                            </div>
                                            <select id="hoaFeesType" class="compact-select w-16 px-1 text-center bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                                <option value="$">$</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Other Costs -->
                                    <div class="input-row mb-2">
                                        <label for="otherCosts" class="input-label w-[35%] text-slate-600 font-semibold">Other Costs</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="otherCosts" value="0" class="compact-input bg-white w-full text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                            </div>
                                            <select id="otherCostsType" class="compact-select w-16 px-1 text-center bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                                <option value="$">$</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- More Options Toggle -->
                                <div class="mt-3 mb-1 text-center no-print">
                                    <button type="button" id="toggleMoreOptions" class="text-xs font-bold text-brand-red hover:text-red-700 hover:underline transition-colors">+ More Options (Increases & Extra Pay)</button>
                                </div>
                                
                                <!-- Hidden Advanced Container -->
                                <div id="moreOptionsContainer" class="hidden border-t border-slate-300 pt-3 mt-2 space-y-3">
                                    <!-- Annual Increases -->
                                    <!-- MODIFIED: Adjusted inner panel for light mode compatibility -->
                                    <div class="calc-option-group !bg-white !border-slate-300 !rounded-md !p-3 !shadow-sm">
                                        <h3 class="text-[11px] font-bold text-slate-800 mb-2 uppercase tracking-wide">Annual Tax & Cost Increase</h3>
                                        <div class="input-row mb-2"><label class="input-label w-[50%] text-slate-600 font-semibold">Property Tax</label><div class="relative w-[50%]"><input type="number" id="taxIncrease" value="0" class="compact-input pr-6 bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red"><span class="absolute right-2 top-1 text-xs text-slate-500">%</span></div></div>
                                        <div class="input-row mb-2"><label class="input-label w-[50%] text-slate-600 font-semibold">Home Ins.</label><div class="relative w-[50%]"><input type="number" id="insIncrease" value="0" class="compact-input pr-6 bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red"><span class="absolute right-2 top-1 text-xs text-slate-500">%</span></div></div>
                                        <div class="input-row mb-2"><label class="input-label w-[50%] text-slate-600 font-semibold">HOA Fee</label><div class="relative w-[50%]"><input type="number" id="hoaIncrease" value="0" class="compact-input pr-6 bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red"><span class="absolute right-2 top-1 text-xs text-slate-500">%</span></div></div>
                                        <div class="input-row mb-2"><label class="input-label w-[50%] text-slate-600 font-semibold">Other Costs</label><div class="relative w-[50%]"><input type="number" id="otherIncrease" value="0" class="compact-input pr-6 bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red"><span class="absolute right-2 top-1 text-xs text-slate-500">%</span></div></div>
                                    </div>
                                    <!-- Extra Payments -->
                                    <div class="calc-option-group !bg-white !border-slate-300 !rounded-md !p-3 !shadow-sm">
                                        <h3 class="text-[11px] font-bold text-slate-800 mb-2 uppercase tracking-wide">Extra Payments</h3>
                                        <div class="mb-3"><div class="flex items-center gap-1 mb-1"><label class="text-[10px] font-bold text-slate-600">Extra Monthly Pay</label></div><div class="flex gap-1"><div class="relative w-[40%]"><span class="absolute left-1.5 top-1 text-[10px] text-slate-500">$</span><input type="number" id="extraMonthly" value="0" class="compact-input pl-4 bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red"></div><span class="text-[10px] self-center text-slate-500 font-semibold">from</span><select id="extraMonthlyMonth" class="compact-select w-[40%] bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red"><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option></select></div></div>
                                        <div class="mb-3"><div class="flex items-center gap-1 mb-1"><label class="text-[10px] font-bold text-slate-600">Extra Yearly Pay</label></div><div class="flex gap-1"><div class="relative w-[40%]"><span class="absolute left-1.5 top-1 text-[10px] text-slate-500">$</span><input type="number" id="extraYearly" value="0" class="compact-input pl-4 bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red"></div><span class="text-[10px] self-center text-slate-500 font-semibold">in</span><select id="extraYearlyMonth" class="compact-select w-[40%] bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red"><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option></select></div></div>
                                        <div>
                                            <div class="flex items-center justify-between gap-1 mb-1"><label class="text-[10px] font-bold text-slate-600">Extra One-time Pay</label></div>
                                            <div id="oneTimePaymentsContainer" class="space-y-2 mb-2">
                                                <div class="one-time-payment-row">
                                                    <div class="flex gap-1 mb-1">
                                                        <div class="relative w-full">
                                                            <span class="absolute left-1.5 top-1 text-[10px] text-slate-500">$</span>
                                                            <input type="number" class="compact-input pl-4 bg-white otp-amount text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red" value="0">
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-1">
                                                        <span class="text-[10px] self-center text-slate-500 font-semibold">in</span>
                                                        <select class="compact-select w-[45%] otp-month bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red">
                                                            <option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option>
                                                        </select>
                                                        <input type="number" class="compact-input w-[35%] otp-year bg-white text-slate-900 font-bold border-slate-300 rounded shadow-sm h-7 focus:border-brand-red focus:ring-1 focus:ring-brand-red" placeholder="Year">
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="button" id="addOneTimePaymentBtn" class="text-[10px] font-semibold text-brand-red hover:text-red-700 hover:underline transition-colors">+ Additional One-Time Payment</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-5 flex gap-2 no-print">
                                    <button type="button" id="calcButton" class="w-full rounded bg-[#166534] py-2 text-sm font-bold text-white shadow-lg hover:bg-green-700 hover:shadow-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#166534]">CALCULATE</button>
                                    <button type="button" id="clearButton" class="rounded border border-slate-400 bg-white px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-brand-red font-bold transition-all shadow-sm">Clear</button>
                                </div>
                            </form>
                        </div>

                        <!-- COLUMN 2: RESULTS -->
                        <div class="flex-1 min-w-0 print-full-width">
                            <div class="rounded border border-slate-300 bg-white p-3 shadow-sm h-full">
                                <div class="mb-2 flex items-center justify-between rounded bg-[#166534] px-3 py-2 text-white shadow-sm"><span class="text-sm font-medium opacity-90">Monthly Pay:</span><span class="text-xl font-bold tracking-tight" id="monthlyPaymentDisplay">$0.00</span></div>
                                <div class="mb-2 flex justify-end gap-3 text-[10px] font-medium text-slate-500 no-print"><button id="printBtn" class="hover:text-[#166534] flex items-center gap-1 transition"><i class="fa-solid fa-print"></i> Print</button><button id="shareBtn" class="hover:text-[#166534] flex items-center gap-1 transition"><i class="fa-solid fa-share-nodes"></i> Share</button><button id="saveBtn" class="hover:text-[#166534] flex items-center gap-1 transition"><i class="fa-regular fa-bookmark"></i> Save</button><input type="text" id="shareUrlInput" class="hidden"></div>
                                <div class="flex flex-row gap-3 items-start">
                                    <div class="flex-1 text-[11px]"><table class="w-full" id="resultTable"><tbody><tr class="border-b border-slate-100 legend-row" data-legend-for="principal"><td class="py-1 text-slate-600">Principal & Interest</td><td class="py-1 text-right font-medium text-slate-900" id="breakdownPI">$0.00</td></tr><tr class="border-b border-slate-100 legend-row" data-legend-for="tax"><td class="py-1 text-slate-600">Property Tax</td><td class="py-1 text-right font-medium text-slate-900" id="breakdownTax">$0.00</td></tr><tr class="border-b border-slate-100 legend-row" data-legend-for="ins"><td class="py-1 text-slate-600">Home Insurance</td><td class="py-1 text-right font-medium text-slate-900" id="breakdownIns">$0.00</td></tr><tr class="border-b border-slate-100 legend-row" data-legend-for="pmi"><td class="py-1 text-slate-600">PMI Insurance</td><td class="py-1 text-right font-medium text-slate-900" id="breakdownPMI">$0.00</td></tr><tr class="border-b border-slate-100 legend-row" data-legend-for="hoa"><td class="py-1 text-slate-600">HOA / Other</td><td class="py-1 text-right font-medium text-slate-900" id="breakdownHOA">$0.00</td></tr><tr class="bg-slate-700 border-t border-slate-600"><td class="py-2 font-bold text-white pl-2 rounded-l-sm">Total Out-of-Pocket</td><td class="py-2 text-right font-bold text-white pr-2 rounded-r-sm" id="breakdownTotal">$0.00</td></tr></tbody></table></div>
                                    <div class="flex flex-col items-center w-[100px] shrink-0 gap-1">
                                        <div class="relative h-[100px] w-[100px] shrink-0">
                                            <svg viewBox="0 0 36 36" class="block h-full w-full rotate-[-90deg]">
                                                <path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="10" />
                                                <!-- MODIFIED: Updated colors to match the reference image -->
                                                <!-- Principal: Blue #428bca -->
                                                <path id="chartRingPrincipal" data-id="principal" class="chart-segment text-[#428bca]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="10"></path>
                                                <!-- Tax: Green #96c03b -->
                                                <path id="chartRingTax" data-id="tax" class="chart-segment text-[#96c03b]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="10"></path>
                                                <!-- Insurance: Dark Red #a90000 -->
                                                <path id="chartRingIns" data-id="ins" class="chart-segment text-[#a90000]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="10"></path>
                                                <!-- PMI: Lighter Red/Pink (Keeping distinct) #d9534f -->
                                                <path id="chartRingPMI" data-id="pmi" class="chart-segment text-[#d9534f]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="10"></path>
                                                <!-- Other: Cyan #30add1 -->
                                                <path id="chartRingHOA" data-id="hoa" class="chart-segment text-[#30add1]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="10"></path>
                                            </svg>
                                            <div id="chartCenterText" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-center z-10 m-4 bg-white/90 backdrop-blur-sm rounded-full shadow-sm">
                                                <div class="text-[9px] text-slate-400 leading-tight">Monthly</div>
                                                <div class="font-bold text-slate-700 text-[10px] leading-tight" id="centerTotalValue">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="calc-results-summary"><table class="w-full text-xs"><tr><td class="py-0.5 text-slate-500">House Price</td><td class="py-0.5 text-right font-medium text-slate-800" id="summaryHousePrice">$0</td></tr><tr><td class="py-0.5 text-slate-500">Loan Amount</td><td class="py-0.5 text-right font-medium text-slate-800" id="summaryLoanAmount">$0</td></tr><tr><td class="py-0.5 text-slate-500">Down Payment</td><td class="py-0.5 text-right font-medium text-slate-800" id="summaryDownPayment">$0</td></tr><tr class="border-t border-slate-200/50"><td class="py-0.5 text-slate-500 pt-1" id="summaryTotalLabel">Total of 360 Mortgage Payments</td><td class="py-0.5 text-right font-semibold text-slate-800 pt-1" id="summaryTotalPayments">$0</td></tr><tr><td class="py-0.5 text-slate-500">Total Interest</td><td class="py-0.5 text-right font-semibold text-slate-800" id="summaryTotalInterest">$0</td></tr><tr><td class="py-0.5 text-slate-500">Mortgage Payoff Date</td><td class="py-0.5 text-right font-bold text-[#166534]" id="summaryPayoffDate">-</td></tr></table></div>
                                <div class="mt-2 no-print"><button type="button" id="toggleTableBtn" class="w-full rounded border border-slate-300 bg-white py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50 transition">View Schedule <i class="fa-solid fa-chevron-down ml-1"></i></button></div>
                            </div>
                            <div id="amortizationContainer" class="mt-4 hidden rounded border border-slate-200 bg-white p-4 shadow-sm"><h3 class="mb-2 text-sm font-bold text-slate-700">Amortization Schedule</h3><div class="overflow-x-auto slim-scroll max-h-80"><table class="w-full min-w-[400px] text-left text-xs text-slate-600"><thead class="bg-slate-100 font-semibold text-slate-700 sticky top-0 shadow-sm"><tr><th class="px-2 py-1.5">Date</th><th class="px-2 py-1.5">Interest</th><th class="px-2 py-1.5">Principal</th><th class="px-2 py-1.5 text-right">Balance</th></tr></thead><tbody id="amortizationBody" class="divide-y divide-slate-100"></tbody></table></div></div>
                        </div>
                    </div>

                    <!-- STRONG VISUAL SEPARATOR -->
                    <div class="w-full max-w-[702px] my-10 border-t-[6px] border-slate-400 rounded-full no-print"></div>

                    <!-- SEO CONTENT (Full Width, Sectioned) -->
                    <div class="w-full max-w-[702px] no-print">
                        <div class="content-section">
                            <div class="bg-gradient-to-r from-brand-dark to-brand-red px-4 py-3 border-b border-white/10">
                                <h2 class="font-bold text-white">Mortgage Calculation Guide</h2>
                            </div>
                            <div class="p-5 text-xs text-slate-600 leading-relaxed grid grid-cols-1 gap-6">
                                
                                <!-- Introduction Section -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                        <i class="fa-solid fa-house-chimney text-[#166534]"></i> What is a Mortgage?
                                    </h3>
                                    <p class="mb-3">
                                        A mortgage is a loan specifically designed for purchasing a home or other real estate. The property itself serves as collateral for the loan. Buying a home is likely the biggest purchase of your life, and our free <strong>Mortgage Calculator</strong> helps you estimate your total monthly payment, not just the loan repayment.
                                    </p>
                                    <p>
                                        By factoring in property taxes, homeowners insurance, and PMI, you get a realistic picture of your true housing costs. Use this tool to compare different loan scenarios, see how a larger down payment affects your wallet, and plan for a financially secure future.
                                    </p>
                                </section>

                                <!-- FORMULA SECTION -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                        <i class="fa-solid fa-calculator text-[#166534]"></i> The Math Behind Your Mortgage
                                    </h3>
                                    <p class="mb-3">Curious about the numbers? Lenders use a standard amortization formula to determine your fixed monthly payment ($M$). It balances your principal ($P$), monthly interest rate ($r$), and the total number of months in your loan ($n$).</p>
                                    
                                    <div class="my-4 flex justify-center">
                                        <div class="bg-white px-6 py-3 rounded border border-slate-200 shadow-sm">
                                            <span class="font-serif text-lg text-slate-800 italic">
                                                M = P <span class="mx-1">&times;</span> 
                                                <span class="inline-block text-center align-middle">
                                                    <span class="block border-b border-slate-400 pb-0.5">r(1 + r)<sup>n</sup></span>
                                                    <span class="block pt-0.5">(1 + r)<sup>n</sup> &minus; 1</span>
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-[11px] text-slate-500 mt-2">
                                        <div class="flex items-center gap-2">
                                            <span class="font-serif font-bold italic text-slate-800 bg-slate-200 w-6 h-6 flex items-center justify-center rounded">M</span>
                                            <span>Monthly Payment</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-serif font-bold italic text-slate-800 bg-slate-200 w-6 h-6 flex items-center justify-center rounded">P</span>
                                            <span>Principal Loan Amount</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-serif font-bold italic text-slate-800 bg-slate-200 w-6 h-6 flex items-center justify-center rounded">r</span>
                                            <span>Monthly Interest Rate</span>
                                        </div>
                                    </div>
                                </section>

                                <!-- DEFINITIONS & FAQ GRID -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    
                                    <!-- Left: Understanding PITI -->
                                    <section class="info-card">
                                        <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                            <i class="fa-solid fa-list-check text-[#166534]"></i> What is PITI?
                                        </h3>
                                        <p class="mb-2">Lenders use the acronym <strong>PITI</strong> to describe the four main components of your monthly mortgage bill:</p>
                                        <ul class="space-y-3 mt-2">
                                            <li>
                                                <strong class="text-slate-700 block mb-0.5">Principal:</strong>
                                                The money that goes directly toward paying down your loan balance.
                                            </li>
                                            <li>
                                                <strong class="text-slate-700 block mb-0.5">Interest:</strong>
                                                The fee the lender charges you for borrowing the money. In the beginning, this makes up most of your payment.
                                            </li>
                                            <li>
                                                <strong class="text-slate-700 block mb-0.5">Taxes:</strong>
                                                Property taxes levied by your local government to fund schools and services. Lenders often collect this monthly.
                                            </li>
                                            <li>
                                                <strong class="text-slate-700 block mb-0.5">Insurance:</strong>
                                                Homeowners insurance protects your home from damage. If you put less than 20% down, this may also include <strong>PMI</strong> (Private Mortgage Insurance).
                                            </li>
                                        </ul>
                                    </section>

                                    <!-- Right: Strategies & Amortization -->
                                    <section class="flex flex-col gap-6">
                                        <div class="info-card">
                                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                                <i class="fa-solid fa-chart-line text-[#166534]"></i> The Amortization Schedule
                                            </h3>
                                            <p class="mb-2">Your <strong>amortization schedule</strong> shows the journey to being debt-free. In the early years, most of your money goes toward interest. Over time, the scales tip, and you start paying off the house (principal) faster.</p>
                                            <p>Use the "View Schedule" button above to see exactly when you'll cross the break-even point.</p>
                                        </div>

                                        <div class="info-card bg-green-50/50 border-green-100">
                                            <h3 class="font-bold text-[#166534] mb-1 flex items-center gap-2">
                                                <i class="fa-solid fa-lightbulb"></i> Smart Strategies
                                            </h3>
                                            <ul class="space-y-2 text-green-800 mt-2">
                                                <li><strong>Avoid PMI:</strong> A down payment of 20% or more typically removes the need for private mortgage insurance.</li>
                                                <li><strong>15 vs. 30 Year:</strong> A 30-year term offers lower monthly bills, while a 15-year term saves massive amounts on total interest.</li>
                                                <li><strong>Extra Payments:</strong> Even adding $50/month to your principal can shave years off your loan term.</li>
                                            </ul>
                                        </div>
                                    </section>
                                </div>

                                <!-- NEW SECTION: Costs of Ownership -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-wallet text-[#166534]"></i> Costs of Ownership & Mortgages
                                    </h3>
                                    <p class="mb-4">Beyond the monthly payment calculated above, successful homeownership requires budgeting for these often-overlooked expenses:</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <!-- Closing Costs -->
                                        <div class="flex gap-3 items-start p-2 rounded hover:bg-slate-100 transition">
                                            <div class="mt-0.5 text-brand-red"><i class="fa-solid fa-file-signature"></i></div>
                                            <div>
                                                <strong class="text-slate-700 block mb-0.5">Closing Costs (Upfront)</strong>
                                                <span class="text-slate-500">Typically 2-5% of the loan amount. Includes appraisal, title search, and origination fees.</span>
                                            </div>
                                        </div>
                                        <!-- Maintenance -->
                                        <div class="flex gap-3 items-start p-2 rounded hover:bg-slate-100 transition">
                                            <div class="mt-0.5 text-brand-red"><i class="fa-solid fa-screwdriver-wrench"></i></div>
                                            <div>
                                                <strong class="text-slate-700 block mb-0.5">Maintenance (Ongoing)</strong>
                                                <span class="text-slate-500">The "1% Rule" suggests budgeting 1% of your home's value annually for repairs and upkeep.</span>
                                            </div>
                                        </div>
                                        <!-- Utilities -->
                                        <div class="flex gap-3 items-start p-2 rounded hover:bg-slate-100 transition">
                                            <div class="mt-0.5 text-brand-red"><i class="fa-solid fa-faucet"></i></div>
                                            <div>
                                                <strong class="text-slate-700 block mb-0.5">Utilities</strong>
                                                <span class="text-slate-500">Heating, cooling, water, and trash collection often cost significantly more than in rentals.</span>
                                            </div>
                                        </div>
                                        <!-- Furniture -->
                                        <div class="flex gap-3 items-start p-2 rounded hover:bg-slate-100 transition">
                                            <div class="mt-0.5 text-brand-red"><i class="fa-solid fa-couch"></i></div>
                                            <div>
                                                <strong class="text-slate-700 block mb-0.5">Furnishing</strong>
                                                <span class="text-slate-500">Filling a larger space requires a budget for furniture, appliances, and window treatments.</span>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <!-- NEW SECTION: How to Lower Payment -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-arrow-trend-down text-[#166534]"></i> How to Lower Your Mortgage Payment
                                    </h3>
                                    <p class="mb-4">Struggling with a high monthly estimate? Here are proven strategies to bring that number down:</p>
                                    <ul class="space-y-3">
                                        <li class="flex gap-3 items-start">
                                            <div class="mt-1 text-green-600"><i class="fa-solid fa-circle-check"></i></div>
                                            <div>
                                                <strong class="text-slate-700 block">Increase Your Down Payment</strong>
                                                <span class="text-slate-500">Every dollar you put down reduces the principal you need to borrow, directly lowering your monthly P&I.</span>
                                            </div>
                                        </li>
                                        <li class="flex gap-3 items-start">
                                            <div class="mt-1 text-green-600"><i class="fa-solid fa-circle-check"></i></div>
                                            <div>
                                                <strong class="text-slate-700 block">Eliminate PMI</strong>
                                                <span class="text-slate-500">If you can hit 20% equity, you can request to remove Private Mortgage Insurance, saving hundreds per month.</span>
                                            </div>
                                        </li>
                                        <li class="flex gap-3 items-start">
                                            <div class="mt-1 text-green-600"><i class="fa-solid fa-circle-check"></i></div>
                                            <div>
                                                <strong class="text-slate-700 block">Shop for Insurance</strong>
                                                <span class="text-slate-500">Homeowners insurance rates vary wildly. Get quotes from multiple providers annually to ensure you aren't overpaying.</span>
                                            </div>
                                        </li>
                                        <li class="flex gap-3 items-start">
                                            <div class="mt-1 text-green-600"><i class="fa-solid fa-circle-check"></i></div>
                                            <div>
                                                <strong class="text-slate-700 block">Recast Your Mortgage</strong>
                                                <span class="text-slate-500">If you come into a lump sum later, ask your lender to "recast" your loan. They re-calculate your payments based on the new lower balance without refinancing.</span>
                                            </div>
                                        </li>
                                    </ul>
                                </section>

                                <!-- NEW SECTION: Common Terms -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-book-open text-[#166534]"></i> Common Mortgage Terms Explained
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-white p-3 rounded border border-slate-200">
                                            <strong class="text-brand-dark block mb-1">LTV (Loan-to-Value)</strong>
                                            <p class="text-slate-500">The ratio of your loan amount to the home's value. Lenders use this to determine risk. 80% LTV is the magic number to avoid PMI.</p>
                                        </div>
                                        <div class="bg-white p-3 rounded border border-slate-200">
                                            <strong class="text-brand-dark block mb-1">DTI (Debt-to-Income)</strong>
                                            <p class="text-slate-500">The percentage of your gross monthly income that goes to paying debts. Most lenders prefer a DTI under 36%.</p>
                                        </div>
                                        <div class="bg-white p-3 rounded border border-slate-200">
                                            <strong class="text-brand-dark block mb-1">Escrow Account</strong>
                                            <p class="text-slate-500">A savings account managed by your lender. A portion of your monthly payment goes here to pay your property taxes and insurance when they are due.</p>
                                        </div>
                                        <div class="bg-white p-3 rounded border border-slate-200">
                                            <strong class="text-brand-dark block mb-1">Fixed vs. Adjustable Rate</strong>
                                            <p class="text-slate-500"><strong>Fixed:</strong> Rate stays the same forever. <br><strong>Adjustable (ARM):</strong> Rate changes after a set period based on market conditions.</p>
                                        </div>
                                    </div>
                                </section>

                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT SIDEBAR (Sticky) -->
                <div class="w-full shrink-0 space-y-4 lg:w-[300px] no-print">
                    <div class="ad-box"><span class="text-xs font-semibold text-slate-400">ADVERTISEMENT<br>300x250</span></div>
                    
                    <!-- NEW SECTION: Mortgage Checklist -->
                    <div class="content-section">
                        <div class="bg-gradient-to-r from-brand-dark to-brand-red px-4 py-2">
                            <h3 class="font-bold text-white text-center">Mortgage Readiness Checklist</h3>
                        </div>
                        <div class="p-4 text-xs text-slate-600">
                            <p class="mb-3 font-medium text-slate-700">Have these ready before you apply:</p>
                            <ul class="space-y-3">
                                <li class="flex gap-2 items-start">
                                    <i class="fa-solid fa-check-circle text-green-600 text-sm mt-0.5"></i>
                                    <span><strong>Proof of Income:</strong> Recent pay stubs & W-2s (last 2 years).</span>
                                </li>
                                <li class="flex gap-2 items-start">
                                    <i class="fa-solid fa-check-circle text-green-600 text-sm mt-0.5"></i>
                                    <span><strong>Credit Report:</strong> Check for errors. Score > 620 is ideal.</span>
                                </li>
                                <li class="flex gap-2 items-start">
                                    <i class="fa-solid fa-check-circle text-green-600 text-sm mt-0.5"></i>
                                    <span><strong>Asset Statements:</strong> 60 days of bank statements for down payment.</span>
                                </li>
                                <li class="flex gap-2 items-start">
                                    <i class="fa-solid fa-check-circle text-green-600 text-sm mt-0.5"></i>
                                    <span><strong>Debt List:</strong> Student loans, auto loans, and credit cards.</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- DYNAMIC SIDEBAR WIDGET -->
                    <!-- The content inside this div is now populated by js/global.js based on the data-category -->
                    <div class="content-section sticky top-4" data-widget="related-tools" data-category="Finance">
                        <!-- Loading State (replaced immediately by JS) -->
                        <div class="p-4 text-center text-slate-400 text-xs">
                            <i class="fa-solid fa-spinner fa-spin mb-2"></i><br>Loading tools...
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="footer-placeholder" class="no-print"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = {
                homePrice: document.getElementById('homePrice'),
                // ... existing inputs ...
                downPaymentInput: document.getElementById('downPaymentInput'),
                downPaymentType: document.getElementById('downPaymentType'),
                
                loanTerm: document.getElementById('loanTermInput'),
                interestRate: document.getElementById('interestRate'),
                startMonth: document.getElementById('startMonth'),
                startYear: document.getElementById('startYear'),
                
                // MODIFIED: New Checkbox
                includeTaxesCosts: document.getElementById('includeTaxesCosts'),
                dynamicCostsContainer: document.getElementById('dynamicCostsContainer'),

                propertyTax: document.getElementById('propertyTax'),
                propertyTaxType: document.getElementById('propertyTaxType'),
                homeInsurance: document.getElementById('homeInsurance'),
                homeInsuranceType: document.getElementById('homeInsuranceType'),
                pmi: document.getElementById('pmi'),
                pmiType: document.getElementById('pmiType'),
                hoaFees: document.getElementById('hoaFees'),
                hoaFeesType: document.getElementById('hoaFeesType'),
                otherCosts: document.getElementById('otherCosts'),
                otherCostsType: document.getElementById('otherCostsType'),
                toggleMoreOptions: document.getElementById('toggleMoreOptions'),
                moreOptionsContainer: document.getElementById('moreOptionsContainer'),
                taxIncrease: document.getElementById('taxIncrease'),
                insIncrease: document.getElementById('insIncrease'),
                hoaIncrease: document.getElementById('hoaIncrease'),
                otherIncrease: document.getElementById('otherIncrease'), 
                extraMonthly: document.getElementById('extraMonthly'),
                extraMonthlyMonth: document.getElementById('extraMonthlyMonth'),
                extraYearly: document.getElementById('extraYearly'),
                extraYearlyMonth: document.getElementById('extraYearlyMonth'),
                oneTimeContainer: document.getElementById('oneTimePaymentsContainer'),
                addOneTimeBtn: document.getElementById('addOneTimePaymentBtn'),
            };
            // ... existing display and chartRings objects ...
            const display = {
                monthlyTotal: document.getElementById('monthlyPaymentDisplay'),
                breakdownPI: document.getElementById('breakdownPI'),
                breakdownTax: document.getElementById('breakdownTax'),
                breakdownIns: document.getElementById('breakdownIns'),
                breakdownPMI: document.getElementById('breakdownPMI'),
                breakdownHOA: document.getElementById('breakdownHOA'),
                breakdownTotal: document.getElementById('breakdownTotal'), 
                housePrice: document.getElementById('summaryHousePrice'),
                loanAmount: document.getElementById('summaryLoanAmount'),
                downPayment: document.getElementById('summaryDownPayment'),
                totalPaymentsLabel: document.getElementById('summaryTotalLabel'),
                totalPayments: document.getElementById('summaryTotalPayments'),
                totalInterest: document.getElementById('summaryTotalInterest'),
                payoffDate: document.getElementById('summaryPayoffDate'),
                amortizationBody: document.getElementById('amortizationBody')
            };
            const chartRings = {
                principal: document.getElementById('chartRingPrincipal'),
                tax: document.getElementById('chartRingTax'),
                ins: document.getElementById('chartRingIns'),
                pmi: document.getElementById('chartRingPMI'),
                hoa: document.getElementById('chartRingHOA')
            };

            const d = new Date();
            inputs.startYear.value = d.getFullYear();
            inputs.startMonth.value = d.getMonth();
            document.querySelector('.otp-year').value = d.getFullYear() + 1;

            // MODIFIED: Toggle Logic for Taxes & Costs
            inputs.includeTaxesCosts.addEventListener('change', () => {
                if (inputs.includeTaxesCosts.checked) {
                    inputs.dynamicCostsContainer.classList.remove('h-0', 'opacity-0', 'mb-0');
                    inputs.dynamicCostsContainer.classList.add('mb-2');
                } else {
                    inputs.dynamicCostsContainer.classList.add('h-0', 'opacity-0', 'mb-0');
                    inputs.dynamicCostsContainer.classList.remove('mb-2');
                }
                calculate();
            });

            inputs.toggleMoreOptions.addEventListener('click', () => {
                inputs.moreOptionsContainer.classList.toggle('hidden');
                const isHidden = inputs.moreOptionsContainer.classList.contains('hidden');
                inputs.toggleMoreOptions.textContent = isHidden ? '+ More Options (Increases & Extra Pay)' : '- Less Options';
            });

            inputs.addOneTimeBtn.addEventListener('click', () => {
                const newRow = document.createElement('div');
                newRow.className = 'one-time-payment-row border-t border-slate-100 pt-2 mt-2 relative';
                newRow.innerHTML = `<button type="button" class="remove-otp absolute -right-2 -top-2 text-red-400 hover:text-red-600 text-xs font-bold px-1">&times;</button><div class="flex gap-1 mb-1"><div class="relative w-full"><span class="absolute left-1.5 top-1 text-[10px] text-slate-400">$</span><input type="number" class="compact-input pl-4 bg-white otp-amount" value="0"></div></div><div class="flex gap-1"><span class="text-[10px] self-center text-slate-400">in</span><select class="compact-select w-[45%] otp-month"><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option></select><input type="number" class="compact-input w-[35%] otp-year" placeholder="Year" value="${parseInt(document.querySelector('.otp-year').value) + 1}"></div>`;
                inputs.oneTimeContainer.appendChild(newRow);
                newRow.querySelectorAll('input, select').forEach(el => el.addEventListener('input', calculate));
                newRow.querySelector('.remove-otp').addEventListener('click', () => { newRow.remove(); calculate(); });
            });

            // MODIFIED: Logic to handle Down Payment Type Switch
            // When switching type, convert the value so the math stays consistent
            inputs.downPaymentType.addEventListener('change', () => {
                const price = parseFloat(inputs.homePrice.value) || 0;
                const currentVal = parseFloat(inputs.downPaymentInput.value) || 0;
                const newType = inputs.downPaymentType.value;

                if (newType === '$') {
                    // Was %, convert to $
                    const dollarAmount = (currentVal / 100) * price;
                    inputs.downPaymentInput.value = Math.round(dollarAmount);
                } else {
                    // Was $, convert to %
                    const percent = price > 0 ? (currentVal / price) * 100 : 0;
                    inputs.downPaymentInput.value = percent.toFixed(2);
                }
                calculate();
            });

            const calculate = () => {
                const homePrice = parseFloat(inputs.homePrice.value) || 0;
                
                // MODIFIED: Get Down Payment based on dropdown
                let downPayment = 0;
                let dpValue = parseFloat(inputs.downPaymentInput.value) || 0;
                if (inputs.downPaymentType.value === '%') {
                    downPayment = (dpValue / 100) * homePrice;
                } else {
                    downPayment = dpValue;
                }

                const loanAmount = Math.max(0, homePrice - downPayment);
                const termYears = parseFloat(inputs.loanTerm.value) || 30;
                const annualRate = parseFloat(inputs.interestRate.value) || 0;
                const monthlyRate = (annualRate / 100) / 12;
                const totalMonths = Math.round(termYears * 12);
                const startM = parseInt(inputs.startMonth.value);
                const startY = parseInt(inputs.startYear.value) || new Date().getFullYear();
                const startDate = new Date(startY, startM);

                // --- DYNAMIC COSTS LOGIC ---
                // Check if costs are included
                const includeCosts = inputs.includeTaxesCosts.checked;

                let taxYear = 0, insYear = 0, pmiYear = 0, hoaMonth = 0, otherMonth = 0;

                if (includeCosts) {
                    // 1. Property Tax (Annual)
                    let taxValue = parseFloat(inputs.propertyTax.value) || 0;
                    let taxType = inputs.propertyTaxType.value; // $ or %
                    taxYear = (taxType === '%') ? (taxValue / 100) * homePrice : taxValue;

                    // 2. Home Insurance (Annual)
                    let insValue = parseFloat(inputs.homeInsurance.value) || 0;
                    let insType = inputs.homeInsuranceType.value;
                    insYear = (insType === '%') ? (insValue / 100) * homePrice : insValue;

                    // 3. PMI (Annual)
                    let pmiValue = parseFloat(inputs.pmi.value) || 0;
                    let pmiType = inputs.pmiType.value;
                    pmiYear = (pmiType === '%') ? (pmiValue / 100) * loanAmount : pmiValue;

                    // 4. HOA Fees (Monthly)
                    let hoaValue = parseFloat(inputs.hoaFees.value) || 0;
                    let hoaType = inputs.hoaFeesType.value;
                    hoaMonth = (hoaType === '%') ? (hoaValue / 100) * homePrice : hoaValue;

                    // 5. Other Costs (Monthly)
                    let otherValue = parseFloat(inputs.otherCosts.value) || 0;
                    let otherType = inputs.otherCostsType.value;
                    otherMonth = (otherType === '%') ? (otherValue / 100) * homePrice : otherValue;
                }

                // Combine HOA & Other for display
                let totalOtherMonth = hoaMonth + otherMonth;

                const taxIncPct = (parseFloat(inputs.taxIncrease.value) || 0) / 100;
                const insIncPct = (parseFloat(inputs.insIncrease.value) || 0) / 100;
                const hoaIncPct = (parseFloat(inputs.hoaIncrease.value) || 0) / 100;
                const otherIncPct = (parseFloat(inputs.otherIncrease.value) || 0) / 100;
                const extMonthlyAmt = parseFloat(inputs.extraMonthly.value) || 0;
                const extMonthlyStartM = parseInt(inputs.extraMonthlyMonth.value);
                const extYearlyAmt = parseFloat(inputs.extraYearly.value) || 0;
                const extYearlyMonth = parseInt(inputs.extraYearlyMonth.value); 
                const oneTimePayments = [];
                document.querySelectorAll('.one-time-payment-row').forEach(row => {
                    const amt = parseFloat(row.querySelector('.otp-amount').value) || 0;
                    if (amt > 0) {
                        oneTimePayments.push({
                            amount: amt,
                            month: parseInt(row.querySelector('.otp-month').value),
                            year: parseInt(row.querySelector('.otp-year').value)
                        });
                    }
                });
                let basePI = 0;
                if (annualRate === 0) basePI = loanAmount / totalMonths;
                else basePI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / (Math.pow(1 + monthlyRate, totalMonths) - 1);
                if(!isFinite(basePI)) basePI = 0;

                let balance = loanAmount;
                let accInterest = 0;
                let finalPayoffDate = new Date(startDate);
                let monthCount = 0;
                let schedule = [];
                let currentD = new Date(startDate);
                
                while (balance > 0.01 && monthCount < 720) {
                    monthCount++;
                    if (monthCount > 1 && (monthCount - 1) % 12 === 0) {
                        // Only increase if we started with a base cost
                        if (includeCosts) {
                            taxYear *= (1 + taxIncPct);
                            insYear *= (1 + insIncPct);
                            hoaMonth *= (1 + hoaIncPct); 
                            otherMonth *= (1 + otherIncPct);
                        }
                    }
                    const interestPayment = balance * monthlyRate;
                    accInterest += interestPayment;
                    let principalPayment = basePI - interestPayment;
                    let extMonStartDate = new Date(startY, extMonthlyStartM);
                    if (currentD >= extMonStartDate) principalPayment += extMonthlyAmt;
                    if (currentD.getMonth() === extYearlyMonth) principalPayment += extYearlyAmt;
                    oneTimePayments.forEach(otp => {
                        if (currentD.getMonth() === otp.month && currentD.getFullYear() === otp.year) principalPayment += otp.amount;
                    });
                    if (principalPayment > balance) principalPayment = balance;
                    balance -= principalPayment;
                    if (monthCount % 12 === 0 || balance <= 0.01) {
                        schedule.push({year: currentD.getFullYear(), interest: accInterest, balance: balance});
                    }
                    currentD.setMonth(currentD.getMonth() + 1);
                }
                finalPayoffDate = new Date(currentD);
                finalPayoffDate.setMonth(finalPayoffDate.getMonth() - 1); 
                const initTax = taxYear / 12;
                const initIns = insYear / 12;
                const initPMI = pmiYear / 12;
                const initTotal = basePI + initTax + initIns + initPMI + hoaMonth + otherMonth;
                const totalPaid = loanAmount + accInterest;

                updateDisplay(basePI, initTax, initIns, initPMI, hoaMonth + otherMonth, initTotal, homePrice, downPayment, loanAmount, totalPaid, accInterest, finalPayoffDate, totalMonths);
                updateChart(basePI, initTax, initIns, initPMI, hoaMonth + otherMonth, initTotal);
                updateAmortizationTable(schedule, loanAmount); 
                saveToHistory(homePrice, annualRate, initTotal);
            };

            const updateDisplay = (pi, tax, ins, pmi, hoa, total, housePrice, downPayment, loan, totalPaid, interest, payoffDate, totalMonths) => {
                const fmt = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
                const fmtCents = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
                display.monthlyTotal.textContent = fmtCents(total);
                display.breakdownPI.textContent = fmtCents(pi);
                display.breakdownTax.textContent = fmtCents(tax);
                display.breakdownIns.textContent = fmtCents(ins);
                display.breakdownPMI.textContent = fmtCents(pmi);
                display.breakdownHOA.textContent = fmtCents(hoa);
                display.breakdownTotal.textContent = fmtCents(total);
                display.housePrice.textContent = fmt(housePrice);
                display.loanAmount.textContent = fmt(loan);
                display.downPayment.textContent = fmt(downPayment);
                display.totalPaymentsLabel.textContent = `Total of ${totalMonths} Mortgage Payments`;
                display.totalPayments.textContent = fmt(totalPaid);
                display.totalInterest.textContent = fmt(interest);
                display.payoffDate.textContent = payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                const centerEl = document.getElementById('centerTotalValue');
                if (centerEl) centerEl.textContent = fmtCents(total);
            };

            const updateChart = (pi, tax, ins, pmi, hoa, total) => {
                if (total <= 0) return;
                const getPct = (val) => (val / total) * 100;
                const pctPI = getPct(pi);
                const pctTax = getPct(tax);
                const pctIns = getPct(ins);
                const pctPMI = getPct(pmi);
                const pctHOA = getPct(hoa);
                const setSegment = (el, pct, offset) => {
                    const val = Math.max(0, pct);
                    if (val < 0.1) el.style.opacity = '0';
                    else {
                        el.style.opacity = '1';
                        el.setAttribute('stroke-dasharray', `${val} ${100 - val}`);
                        el.setAttribute('stroke-dashoffset', -offset);
                    }
                };
                let offset = 0;
                setSegment(chartRings.principal, pctPI, offset); offset += pctPI;
                setSegment(chartRings.tax, pctTax, offset); offset += pctTax;
                setSegment(chartRings.ins, pctIns, offset); offset += pctIns;
                setSegment(chartRings.pmi, pctPMI, offset); offset += pctPMI;
                setSegment(chartRings.hoa, pctHOA, offset);
            };

            const labels = { principal: 'Principal & Int.', tax: 'Property Tax', ins: 'Home Insurance', pmi: 'PMI', hoa: 'HOA / Other' };
            const highlightSegment = (id) => {
                Object.values(chartRings).forEach(s => s.style.opacity = '0.3');
                const active = document.querySelector(`.chart-segment[data-id="${id}"]`);
                if(active) { active.style.opacity = '1'; active.style.strokeWidth = '12'; }
                document.querySelectorAll('#resultTable tr[data-legend-for]').forEach(r => r.classList.remove('bg-yellow-50'));
                const activeRow = document.querySelector(`#resultTable tr[data-legend-for="${id}"]`);
                if(activeRow) activeRow.classList.add('bg-yellow-50');
                const valEl = document.getElementById(id === 'principal' ? 'breakdownPI' : id === 'tax' ? 'breakdownTax' : id === 'ins' ? 'breakdownIns' : id === 'pmi' ? 'breakdownPMI' : 'breakdownHOA');
                if (valEl) {
                    const centerContainer = document.getElementById('chartCenterText');
                    centerContainer.innerHTML = `<div class="text-[9px] text-slate-500 leading-tight">${labels[id]}</div><div class="font-bold text-slate-800 text-[10px] leading-tight">${valEl.textContent}</div>`;
                }
            };
            const resetHighlight = () => {
                Object.values(chartRings).forEach(s => { s.style.opacity = '1'; s.style.strokeWidth = '10'; });
                document.querySelectorAll('#resultTable tr[data-legend-for]').forEach(r => r.classList.remove('bg-yellow-50'));
                const totalVal = document.getElementById('monthlyPaymentDisplay').textContent;
                const centerContainer = document.getElementById('chartCenterText');
                centerContainer.innerHTML = `<div class="text-[9px] text-slate-400 leading-tight">Monthly</div><div class="font-bold text-slate-700 text-[10px] leading-tight">${totalVal}</div>`;
            };
            document.querySelectorAll('.chart-segment').forEach(seg => {
                seg.addEventListener('mouseenter', () => highlightSegment(seg.dataset.id));
                seg.addEventListener('mouseleave', resetHighlight);
            });
            document.querySelectorAll('#resultTable tr[data-legend-for]').forEach(row => {
                row.addEventListener('mouseenter', () => highlightSegment(row.dataset.legendFor));
                row.addEventListener('mouseleave', resetHighlight);
            });

            const updateAmortizationTable = (schedule, initialLoan) => {
                let html = '';
                let prevInterest = 0;
                let prevBalance = initialLoan;
                schedule.forEach(item => {
                    const yearInterest = item.interest - prevInterest;
                    const yearPrincipal = prevBalance - item.balance; 
                    html += `<tr class="hover:bg-slate-50 transition-colors"><td class="px-2 py-1.5 font-medium text-slate-800">${item.year}</td><td class="px-2 py-1.5 text-slate-600">$${Math.round(yearInterest).toLocaleString()}</td><td class="px-2 py-1.5 text-slate-600">$${Math.round(yearPrincipal).toLocaleString()}</td><td class="px-2 py-1.5 text-right font-medium text-slate-800">$${Math.round(item.balance).toLocaleString()}</td></tr>`;
                    prevInterest = item.interest;
                    prevBalance = item.balance;
                });
                display.amortizationBody.innerHTML = html;
            };

            document.getElementById('saveBtn').addEventListener('click', () => {
                const presetName = prompt("Name this calculation (e.g., 'Dream House 2025'):");
                if (presetName) {
                    const preset = { name: presetName, date: new Date().toISOString(), inputs: `$${parseFloat(inputs.homePrice.value).toLocaleString()} Home, ${inputs.interestRate.value}% Rate`, calculator: 'Mortgage Calculator', url: window.location.href };
                    let allPresets = JSON.parse(localStorage.getItem('dailyCalcPresets')) || {};
                    if (!allPresets['Mortgage Calculator']) allPresets['Mortgage Calculator'] = [];
                    allPresets['Mortgage Calculator'].push(preset);
                    localStorage.setItem('dailyCalcPresets', JSON.stringify(allPresets));
                    const btn = document.getElementById('saveBtn');
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = `<i class="fa-solid fa-check text-green-600"></i> Saved`;
                    setTimeout(() => btn.innerHTML = originalHtml, 2000);
                }
            });

            // --- SMART HISTORY SAVER ---
            let historyDebounce;
            function saveToHistory(price, rate, monthly) {
                clearTimeout(historyDebounce);
                
                // Increased delay to 4000ms (4s) to ensure user has finished typing
                historyDebounce = setTimeout(() => {
                    
                    // 1. Filter Junk: Don't save if price is unrealistically low (e.g. user is mid-typing "100")
                    if (price < 1000 || monthly <= 0) return;

                    const historyItem = { 
                        calculator: 'Mortgage Calculator', 
                        inputs: `$${price.toLocaleString()} @ ${rate}%`, 
                        result: `$${monthly.toLocaleString(undefined, {maximumFractionDigits: 2})}/mo`, 
                        timestamp: new Date().toISOString(), 
                        url: window.location.href 
                    };

                    let history = [];
                    try {
                        history = JSON.parse(localStorage.getItem('dailyCalcHistory')) || [];
                    } catch(e) {
                        history = [];
                    }

                    // 2. Filter Duplicates: Check if this entry is identical to the very last one
                    if (history.length > 0) {
                        const lastItem = history[0];
                        // If inputs and result are the same, skip saving (prevents duplicate spam)
                        if (lastItem.inputs === historyItem.inputs && lastItem.result === historyItem.result) {
                            return; 
                        }
                    }

                    history.unshift(historyItem);
                    
                    // Keep history clean (max 50 items)
                    if (history.length > 50) history.pop(); 
                    
                    localStorage.setItem('dailyCalcHistory', JSON.stringify(history));
                }, 4000); 
            }

            document.getElementById('shareBtn').addEventListener('click', () => {
                const params = new URLSearchParams();
                params.set('price', inputs.homePrice.value);
                // MODIFIED: Share URL builder logic might need to handle 'dp_amt' vs 'dp_pct' if we wanted robust URL state, 
                // but standard 'dp_amt' works fine as calculation derives from inputs.
                params.set('dp_amt', inputs.downPaymentInput.value); // Using the unified input
                params.set('dp_type', inputs.downPaymentType.value); // Saving type
                
                params.set('term', inputs.loanTerm.value);
                params.set('rate', inputs.interestRate.value);
                params.set('tax', inputs.propertyTax.value);
                params.set('ins', inputs.homeInsurance.value);
                params.set('pmi', inputs.pmi.value);
                params.set('hoa', inputs.hoaFees.value);
                if (inputs.extraMonthly.value > 0) params.set('em', inputs.extraMonthly.value);
                const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => { showCopySuccess(); }).catch(() => { fallbackCopy(shareUrl); });
                } else { fallbackCopy(shareUrl); }
            });
            function fallbackCopy(text) {
                const tempInput = document.getElementById('shareUrlInput');
                tempInput.value = text;
                tempInput.classList.remove('hidden');
                tempInput.select();
                try { document.execCommand('copy'); showCopySuccess(); } catch (err) { prompt("Copy this link to share:", text); }
                tempInput.classList.add('hidden');
            }
            function showCopySuccess() {
                const btn = document.getElementById('shareBtn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="fa-solid fa-check text-green-600"></i> Copied`;
                setTimeout(() => btn.innerHTML = originalHtml, 2000);
            }
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            
            // MODIFIED: URL Params Logic for Unified Down Payment
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('price')) {
                inputs.homePrice.value = urlParams.get('price');
                
                if (urlParams.has('dp_amt')) inputs.downPaymentInput.value = urlParams.get('dp_amt');
                if (urlParams.has('dp_type')) inputs.downPaymentType.value = urlParams.get('dp_type');
                
                if (urlParams.has('term')) inputs.loanTerm.value = urlParams.get('term');
                if (urlParams.has('rate')) inputs.interestRate.value = urlParams.get('rate');
                if (urlParams.has('tax')) inputs.propertyTax.value = urlParams.get('tax');
                if (urlParams.has('ins')) inputs.homeInsurance.value = urlParams.get('ins');
                if (urlParams.has('pmi')) inputs.pmi.value = urlParams.get('pmi');
                if (urlParams.has('hoa')) inputs.hoaFees.value = urlParams.get('hoa');
                if (urlParams.has('em')) {
                    inputs.extraMonthly.value = urlParams.get('em');
                    inputs.moreOptionsContainer.classList.remove('hidden');
                    inputs.toggleMoreOptions.textContent = '- Less Options';
                }
            }
            
            // Re-attach listeners for the new unified inputs
            inputs.homePrice.addEventListener('input', calculate);
            inputs.downPaymentInput.addEventListener('input', calculate);
            inputs.includeTaxesCosts.addEventListener('change', calculate);
            
            const allInputs = document.querySelectorAll('input, select');
            allInputs.forEach(el => { 
                if(el.id !== 'homePrice' && el.id !== 'downPaymentInput' && el.id !== 'downPaymentType' && el.id !== 'includeTaxesCosts') { 
                    el.addEventListener('input', calculate); 
                } 
            });
            document.getElementById('calcButton').addEventListener('click', calculate);
            document.getElementById('clearButton').addEventListener('click', () => { window.location.href = window.location.pathname; });
            document.getElementById('toggleTableBtn').addEventListener('click', () => { document.getElementById('amortizationContainer').classList.toggle('hidden'); });
            calculate();
        });
    </script>
</body>
</html>
