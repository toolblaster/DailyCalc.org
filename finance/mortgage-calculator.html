<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Calculator | Monthly Payment & Interest</title>
    <meta name="description" content="Free Mortgage Calculator. Estimate 2025 monthly payments, taxes, PMI & insurance. View amortization schedules and payoff strategies for US fixed-rate loans.">
    <meta name="keywords" content="mortgage calculator, home loan, pmi calculator, amortization schedule, interest rate, housing market">
    
    <link rel="canonical" href="https://dailycalc.org/finance/mortgage-calculator.html">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
    
    <!-- Global CSS (Now contains centralized print styles) -->
    <link rel="stylesheet" href="../css/global.css">
    
    <!-- Tailwind & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../js/tailwind-config.js"></script>
    
    <!-- Layout Scripts -->
    <script src="../js/global.js" defer></script>
    <script src="../js/common-layout.js" defer></script>

    <!-- SCHEMA MARKUP (SoftwareApplication) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Mortgage Calculator",
      "url": "https://dailycalc.org/finance/mortgage-calculator.html",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Any",
      "description": "A comprehensive free mortgage calculator that estimates monthly payments including principal, interest, taxes, homeowners insurance, and PMI. Features interactive charts and amortization schedules.",
      "browserRequirements": "Requires JavaScript. Works on all modern browsers.",
      "permissions": "None",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "Monthly Payment Calculation",
        "Amortization Schedule",
        "Extra Payment Estimation",
        "PMI and Tax Inclusion",
        "Interactive Donut Chart"
      ],
      "author": {
        "@type": "Organization",
        "name": "DailyCalc.org"
      }
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [{
        "@type": "Question",
        "name": "Do I really need a 20% down payment?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "No. While 20% avoids Private Mortgage Insurance (PMI), many lenders accept as little as 3% - 3.5% for conventional or FHA loans. However, a lower down payment usually means a higher monthly payment."
        }
      }, {
        "@type": "Question",
        "name": "What is included in my monthly payment?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Your total payment typically includes Principal and Interest (the loan itself), plus Escrow items like Property Taxes and Homeowners Insurance. If your down payment is under 20%, it may also include PMI."
        }
      }, {
        "@type": "Question",
        "name": "How can I pay off my mortgage faster?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Making extra payments toward your principal balance reduces total interest. Even one extra payment per year can shave years off a 30-year term. Use the \"More Options\" section above to test this strategy."
        }
      }, {
        "@type": "Question",
        "name": "What is a \"good\" interest rate?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Rates fluctuate daily based on the economy and your credit score. Generally, a score above 740 secures the lowest rates. Compare quotes from at least 3 lenders to ensure you aren't overpaying."
        }
      }, {
        "@type": "Question",
        "name": "Should I choose a 15-year or 30-year term?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A 30-year loan offers lower monthly payments, making it easier to qualify. A 15-year loan has higher monthly payments but saves you tens of thousands of dollars in interest over the life of the loan."
        }
      }]
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased">
    
    <div id="header-placeholder" class="no-print"></div>

    <!-- NEW: Floating Tooltip for Chart (Dynamic Background) -->
    <!-- Removed bg-slate-900 and text-white to allow JS override -->
    <div id="chartTooltip" class="fixed z-50 pointer-events-none opacity-0 transition-opacity duration-150 text-xs rounded-md px-3 py-2 shadow-xl border border-white/20 transform -translate-x-1/2 -translate-y-full mt-[-10px] backdrop-blur-sm font-medium text-white drop-shadow-md">
        <!-- Content injected by JS -->
    </div>

    <main class="bg-slate-50">
        <div class="mx-auto main-container px-2 py-4 sm:px-4">
            
            <!-- Breadcrumb -->
            <nav class="mb-3 text-xs text-slate-600 no-print" aria-label="Breadcrumb">
                <ol class="flex items-center gap-1">
                    <li><a href="/" class="hover:text-[#518428]">Home</a></li>
                    <li><span class="text-slate-400">/</span></li>
                    <li><a href="/finance/" class="hover:text-[#518428]">Finance</a></li>
                    <li><span class="text-slate-400">/</span></li>
                    <li><span class="font-medium text-slate-700">Mortgage Calculator</span></li>
                </ol>
            </nav>

            <!-- PAGE TITLE -->
            <h1 class="mb-6 font-heading text-2xl font-bold text-brand-dark no-print">
                <span class="bg-gradient-to-r from-brand-dark to-brand-red bg-clip-text text-transparent">Mortgage Calculator</span>
                <span class="ml-2 inline-block rounded-full bg-slate-200/70 border border-slate-300 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-slate-700 align-middle">Fixed-Rate</span>
            </h1>

            <!-- TOP ROW: CALCULATOR + SIDEBAR -->
            <div class="flex flex-col gap-4 lg:flex-row mb-8">
                
                <!-- LEFT: CALCULATOR CONTAINER (Inputs + Results) -->
                <div class="flex-1 min-w-0">
                    
                    <!-- CALCULATOR HEADER BAR -->
                    <div class="calc-tool-header no-print">
                        <!-- Updated icon to match category card (fa-house-chimney) -->
                        <i class="fa-solid fa-house-chimney text-sm opacity-90"></i>
                        <span class="text-xs font-medium">Modify the values and click the Calculate button to use</span>
                    </div>

                    <!-- CALCULATOR CONTENT WRAPPER -->
                    <div id="calculator-wrapper" class="flex flex-col gap-4 border-x border-b border-slate-400 bg-white p-3 shadow-sm rounded-b-md md:flex-row md:items-start">
                        
                        <!-- COLUMN 1: INPUTS -->
                        <div class="calc-input-section w-full shrink-0 bg-[#EEEEEE] p-4 rounded border border-slate-400 md:w-[280px] print-break-inside-avoid shadow-lg text-slate-900">
                            <form id="mortgageForm">
                                <!-- Inputs -->
                                <div class="input-row mb-3">
                                    <label for="homePrice" class="input-label w-[35%] text-slate-800 font-bold">Home Price</label>
                                    <div class="relative w-[65%]">
                                        <span class="absolute left-2 top-1.5 text-xs text-slate-600 z-10">$</span>
                                        <input type="number" id="homePrice" value="400000" class="compact-input pl-6">
                                    </div>
                                </div>
                                
                                <!-- Down Payment -->
                                <div class="input-row mb-3">
                                    <label for="downPaymentInput" class="input-label w-[35%] text-slate-800 font-bold">Down Payment</label>
                                    <div class="flex w-[65%] gap-1">
                                        <div class="relative flex-1">
                                            <input type="number" id="downPaymentInput" value="20" class="compact-input w-full">
                                        </div>
                                        <select id="downPaymentType" aria-label="Down payment unit" class="compact-select w-16 px-1 text-center">
                                            <option value="%">%</option>
                                            <option value="$">$</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="input-row mb-3">
                                    <!-- A11Y FIX: Corrected 'for' attribute to match input ID 'loanTermInput' -->
                                    <label for="loanTermInput" class="input-label w-[35%] text-slate-800 font-bold">Loan Term</label>
                                    <div class="w-[65%] flex items-center gap-2">
                                        <input type="number" id="loanTermInput" value="30" class="compact-input w-full">
                                        <span class="text-xs text-slate-700 whitespace-nowrap font-medium">years</span>
                                    </div>
                                </div>
                                
                                <div class="input-row mb-3">
                                    <label for="interestRate" class="input-label w-[40%] text-slate-800 font-bold whitespace-normal leading-tight">Interest Rate <span class="font-normal text-[10px] text-slate-600 block sm:inline">(Fixed)</span></label>
                                    <div class="relative w-[60%]">
                                        <input type="number" id="interestRate" value="6.5" step="0.01" class="compact-input pr-6">
                                        <span class="absolute right-2 top-1.5 text-xs text-slate-600">%</span>
                                    </div>
                                </div>
                                
                                <div class="input-row mb-4">
                                    <span class="input-label w-[35%] text-slate-800 font-bold" id="startDateLabel">Start Date</span>
                                    <div class="flex w-[65%] gap-1">
                                        <select id="startMonth" aria-labelledby="startDateLabel" aria-label="Start Month" class="compact-select w-[50%]">
                                            <option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option>
                                        </select>
                                        <!-- A11Y FIX: Added placeholder-slate-500 for better contrast -->
                                        <input type="number" id="startYear" aria-labelledby="startDateLabel" aria-label="Start Year" class="compact-input w-[50%] placeholder-slate-500" placeholder="Year">
                                    </div>
                                </div>
                                
                                <!-- Checkbox -->
                                <div class="mt-2 mb-3 flex items-center justify-end gap-2 border-t border-slate-300 pt-3">
                                    <label for="includeTaxesCosts" class="text-xs font-bold text-slate-800 select-none cursor-pointer hover:text-brand-red transition-colors">Include Taxes & Costs Below</label>
                                    <input type="checkbox" id="includeTaxesCosts" checked class="accent-brand-red h-4 w-4 cursor-pointer rounded border-slate-300 bg-white focus:ring-brand-red">
                                </div>

                                <!-- Standard Costs (Dynamic Inputs) -->
                                <div id="dynamicCostsContainer" class="transition-all duration-300 ease-in-out overflow-hidden">
                                    
                                    <!-- Section Label: Annual Tax & Cost -->
                                    <div class="flex justify-end mb-2">
                                        <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wide border-b border-slate-200 pb-0.5">Annual Tax & Cost</span>
                                    </div>

                                    <!-- Property Tax -->
                                    <div class="input-row mb-2">
                                        <label for="propertyTax" class="input-label w-[35%] text-slate-700 font-semibold">Property Tax</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="propertyTax" value="4800" class="compact-input w-full">
                                            </div>
                                            <select id="propertyTaxType" aria-label="Property tax unit" class="compact-select w-16 px-1 text-center">
                                                <option value="$">$</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Home Insurance -->
                                    <div class="input-row mb-2">
                                        <label for="homeInsurance" class="input-label w-[35%] text-slate-700 font-semibold">Home Ins.</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="homeInsurance" value="1500" class="compact-input w-full">
                                            </div>
                                            <select id="homeInsuranceType" aria-label="Home insurance unit" class="compact-select w-16 px-1 text-center">
                                                <option value="$">$</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- PMI -->
                                    <div class="input-row mb-2">
                                        <label for="pmi" class="input-label w-[35%] text-slate-700 font-semibold">PMI</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="pmi" value="0.5" class="compact-input w-full">
                                            </div>
                                            <select id="pmiType" aria-label="PMI unit" class="compact-select w-16 px-1 text-center">
                                                <option value="%">%</option>
                                                <option value="$">$</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- HOA Fees -->
                                    <div class="input-row mb-2">
                                        <label for="hoaFees" class="input-label w-[35%] text-slate-700 font-semibold">HOA Fee</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="hoaFees" value="0" class="compact-input w-full">
                                            </div>
                                            <select id="hoaFeesType" aria-label="HOA fee unit" class="compact-select w-16 px-1 text-center">
                                                <option value="$">$</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Other Costs -->
                                    <div class="input-row mb-2">
                                        <label for="otherCosts" class="input-label w-[35%] text-slate-700 font-semibold">Other Costs</label>
                                        <div class="flex w-[65%] gap-1">
                                            <div class="relative flex-1">
                                                <input type="number" id="otherCosts" value="0" class="compact-input w-full">
                                            </div>
                                            <select id="otherCostsType" aria-label="Other costs unit" class="compact-select w-16 px-1 text-center">
                                                <option value="$">$</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- More Options Toggle -->
                                <div class="mt-3 mb-1 text-center no-print">
                                    <button type="button" id="toggleMoreOptions" class="text-xs font-bold text-brand-red hover:text-red-700 hover:underline transition-colors">+ More Options (Increases & Extra Pay)</button>
                                </div>
                                
                                <!-- Hidden Advanced Container -->
                                <div id="moreOptionsContainer" class="hidden border-t border-slate-300 pt-3 mt-2 space-y-3">
                                    <!-- Annual Increases -->
                                    <div class="calc-option-group !bg-white !border-slate-300 !rounded-md !p-3 !shadow-sm">
                                        <h3 class="text-[11px] font-bold text-slate-800 mb-2 uppercase tracking-wide">Annual Tax & Cost Increase</h3>
                                        <!-- A11Y FIX: Added explicit 'for' attributes to labels in advanced section -->
                                        <div class="input-row mb-2"><label for="taxIncrease" class="input-label w-[50%] text-slate-700 font-semibold">Property Tax</label><div class="relative w-[50%]"><input type="number" id="taxIncrease" value="0" class="compact-input pr-6"><span class="absolute right-2 top-1 text-xs text-slate-600">%</span></div></div>
                                        <div class="input-row mb-2"><label for="insIncrease" class="input-label w-[50%] text-slate-700 font-semibold">Home Ins.</label><div class="relative w-[50%]"><input type="number" id="insIncrease" value="0" class="compact-input pr-6"><span class="absolute right-2 top-1 text-xs text-slate-600">%</span></div></div>
                                        <div class="input-row mb-2"><label for="hoaIncrease" class="input-label w-[50%] text-slate-700 font-semibold">HOA Fee</label><div class="relative w-[50%]"><input type="number" id="hoaIncrease" value="0" class="compact-input pr-6"><span class="absolute right-2 top-1 text-xs text-slate-600">%</span></div></div>
                                        <div class="input-row mb-2"><label for="otherIncrease" class="input-label w-[50%] text-slate-700 font-semibold">Other Costs</label><div class="relative w-[50%]"><input type="number" id="otherIncrease" value="0" class="compact-input pr-6"><span class="absolute right-2 top-1 text-xs text-slate-600">%</span></div></div>
                                    </div>
                                    <!-- Extra Payments -->
                                    <div class="calc-option-group !bg-white !border-slate-300 !rounded-md !p-3 !shadow-sm">
                                        <h3 class="text-[11px] font-bold text-slate-800 mb-2 uppercase tracking-wide">Extra Payments</h3>
                                        <div class="mb-3"><div class="flex items-center gap-1 mb-1"><label for="extraMonthly" class="text-[10px] font-bold text-slate-700">Extra Monthly Pay</label></div><div class="flex gap-1"><div class="relative w-[40%]"><span class="absolute left-1.5 top-1 text-[10px] text-slate-600">$</span><input type="number" id="extraMonthly" value="0" class="compact-input pl-4"></div><span class="text-[10px] self-center text-slate-600 font-semibold">from</span><select id="extraMonthlyMonth" aria-label="Extra monthly payment start month" class="compact-select w-[40%]"><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option></select></div></div>
                                        <div class="mb-3"><div class="flex items-center gap-1 mb-1"><label for="extraYearly" class="text-[10px] font-bold text-slate-700">Extra Yearly Pay</label></div><div class="flex gap-1"><div class="relative w-[40%]"><span class="absolute left-1.5 top-1 text-[10px] text-slate-600">$</span><input type="number" id="extraYearly" value="0" class="compact-input pl-4"></div><span class="text-[10px] self-center text-slate-600 font-semibold">in</span><select id="extraYearlyMonth" aria-label="Extra yearly payment month" class="compact-select w-[40%]"><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option></select></div></div>
                                        <div>
                                            <div class="flex items-center justify-between gap-1 mb-1"><label class="text-[10px] font-bold text-slate-700">Extra One-time Pay</label></div>
                                            <div id="oneTimePaymentsContainer" class="space-y-2 mb-2">
                                                <div class="one-time-payment-row">
                                                    <div class="flex gap-1 mb-1">
                                                        <div class="relative w-full">
                                                            <span class="absolute left-1.5 top-1 text-[10px] text-slate-600">$</span>
                                                            <input type="number" aria-label="One-time payment amount" class="compact-input pl-4 otp-amount" value="0">
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-1">
                                                        <span class="text-[10px] self-center text-slate-600 font-semibold">in</span>
                                                        <select class="compact-select w-[45%] otp-month" aria-label="One-time payment month">
                                                            <option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option>
                                                        </select>
                                                        <!-- A11Y FIX: placeholder-slate-500 -->
                                                        <input type="number" aria-label="One-time payment year" class="compact-input w-[35%] otp-year placeholder-slate-500" placeholder="Year">
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="button" id="addOneTimePaymentBtn" class="text-[10px] font-semibold text-brand-red hover:text-red-700 hover:underline transition-colors">+ Additional One-Time Payment</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-5 flex flex-col gap-2 no-print">
                                    <div class="flex gap-2">
                                        <button type="button" id="calcButton" class="w-full rounded bg-[#518428] py-2 text-sm font-bold text-white shadow-lg hover:bg-green-700 hover:shadow-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#518428]">CALCULATE</button>
                                        <button type="button" id="clearButton" class="rounded border border-slate-400 bg-white px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-brand-red font-bold transition-all shadow-sm">Clear</button>
                                    </div>
                                    <p class="text-[10px] text-slate-500 text-center italic">* Currently supports fixed-rate mortgages only.</p>
                                </div>
                            </form>
                        </div>

                        <!-- COLUMN 2: RESULTS (REDESIGNED) -->
                        <div class="flex-1 min-w-0 print-full-width flex flex-col gap-4">

                            <!-- UNIFIED DASHBOARD CARD -->
                            <div class="rounded-lg border border-slate-400 bg-white shadow-lg overflow-hidden flex flex-col">
                                
                                <!-- 1. HEADER: Result & Actions -->
                                <div class="result-header">
                                    <div>
                                        <div class="text-[10px] font-semibold uppercase tracking-wider text-green-100/80">Monthly Pay</div>
                                        <div class="text-2xl font-bold tracking-tight leading-none mt-0.5" id="monthlyPaymentDisplay">$0.00</div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex gap-1.5 no-print">
                                        <button id="saveBtn" class="h-7 w-7 flex items-center justify-center rounded bg-white/10 hover:bg-white/20 text-white transition-all backdrop-blur-sm" title="Save Calculation">
                                            <i class="fa-regular fa-bookmark text-xs"></i>
                                        </button>
                                        <button id="shareBtn" class="h-7 w-7 flex items-center justify-center rounded bg-white/10 hover:bg-white/20 text-white transition-all backdrop-blur-sm" title="Share">
                                            <i class="fa-solid fa-share-nodes text-xs"></i>
                                        </button>
                                        <button id="downloadCsvBtn" class="h-7 w-7 flex items-center justify-center rounded bg-white/10 hover:bg-white/20 text-white transition-all backdrop-blur-sm" title="Download CSV">
                                            <i class="fa-solid fa-file-csv text-xs"></i>
                                        </button>
                                        <button id="printBtn" class="h-7 w-7 flex items-center justify-center rounded bg-white/10 hover:bg-white/20 text-white transition-all backdrop-blur-sm" title="Print">
                                            <i class="fa-solid fa-print text-xs"></i>
                                        </button>
                                    </div>
                                    <input type="text" id="shareUrlInput" class="hidden">
                                </div>

                                <!-- 2. DENSE CONTENT AREA (Chart + Table) -->
                                <div class="flex flex-col sm:flex-row border-b border-slate-200">
                                    
                                    <!-- Chart (Left) -->
                                    <div class="flex flex-col items-center justify-center p-4 bg-white sm:border-r border-slate-100 sm:w-1/3 min-w-[120px]">
                                        <div class="relative w-24 h-24 shrink-0">
                                            <svg viewBox="0 0 36 36" class="block h-full w-full rotate-[-90deg]">
                                                <path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="6" />
                                                <path id="chartRingPrincipal" data-id="principal" class="chart-segment text-[#428bca]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="6"></path>
                                                <path id="chartRingTax" data-id="tax" class="chart-segment text-[#96c03b]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="6"></path>
                                                <path id="chartRingIns" data-id="ins" class="chart-segment text-[#a90000]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="6"></path>
                                                <path id="chartRingPMI" data-id="pmi" class="chart-segment text-[#d9534f]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="6"></path>
                                                <path id="chartRingHOA" data-id="hoa" class="chart-segment text-[#30add1]" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="6"></path>
                                            </svg>
                                            <div id="chartCenterText" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-center">
                                                <!-- Static text instead of dynamic -->
                                                <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide">Monthly</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Table (Right) -->
                                    <div class="flex-1 w-full text-xs">
                                        <div id="resultTable" class="w-full">
                                            <!-- Principal -->
                                            <div class="flex items-center justify-between px-4 py-2 even:bg-slate-50 border-b border-slate-50 hover:bg-slate-100 transition cursor-pointer group" data-legend-for="principal">
                                                <div class="flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full bg-[#428bca]"></span>
                                                    <span class="text-slate-700 font-medium group-hover:text-slate-900">Principal & Interest</span>
                                                </div>
                                                <span class="font-bold text-slate-800" id="breakdownPI">$0</span>
                                            </div>
                                            <!-- Tax -->
                                            <div class="flex items-center justify-between px-4 py-2 bg-slate-50 border-b border-slate-50 hover:bg-slate-100 transition cursor-pointer group" data-legend-for="tax">
                                                <div class="flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full bg-[#96c03b]"></span>
                                                    <span class="text-slate-700 font-medium group-hover:text-slate-900">Property Tax</span>
                                                </div>
                                                <span class="font-bold text-slate-800" id="breakdownTax">$0</span>
                                            </div>
                                            <!-- Insurance -->
                                            <div class="flex items-center justify-between px-4 py-2 border-b border-slate-50 hover:bg-slate-100 transition cursor-pointer group" data-legend-for="ins">
                                                <div class="flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full bg-[#a90000]"></span>
                                                    <span class="text-slate-700 font-medium group-hover:text-slate-900">Home Insurance</span>
                                                </div>
                                                <span class="font-bold text-slate-800" id="breakdownIns">$0</span>
                                            </div>
                                            <!-- PMI -->
                                            <div class="flex items-center justify-between px-4 py-2 bg-slate-50 border-b border-slate-50 hover:bg-slate-100 transition cursor-pointer group" data-legend-for="pmi">
                                                <div class="flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full bg-[#d9534f]"></span>
                                                    <span class="text-slate-700 font-medium group-hover:text-slate-900">PMI</span>
                                                </div>
                                                <span class="font-bold text-slate-800" id="breakdownPMI">$0</span>
                                            </div>
                                            <!-- HOA -->
                                            <div class="flex items-center justify-between px-4 py-2 border-b border-slate-100 hover:bg-slate-100 transition cursor-pointer group" data-legend-for="hoa">
                                                <div class="flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full bg-[#30add1]"></span>
                                                    <span class="text-slate-700 font-medium group-hover:text-slate-900">HOA / Other</span>
                                                </div>
                                                <span class="font-bold text-slate-800" id="breakdownHOA">$0</span>
                                            </div>
                                            <!-- Total -->
                                            <div class="flex items-center justify-between px-4 py-3 bg-[#DDDDDD]">
                                                <span class="text-slate-800 font-bold text-[11px] uppercase tracking-wide">Total Out-of-Pocket</span>
                                                <span class="font-bold text-slate-900 text-xs" id="breakdownTotal">$0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 3. SUMMARY FOOTER (Refined to 3 cols max, card style) -->
                                <div class="bg-slate-50 px-4 py-4 border-t border-slate-100">
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-xs">
                                        
                                        <!-- Loan Amount -->
                                        <div class="stat-card border-l-[#428bca]">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5">Loan Amount</span>
                                            <span class="font-bold text-slate-800 text-xs" id="summaryLoanAmount">$0</span>
                                        </div>
                                        
                                        <!-- Down Payment -->
                                        <div class="stat-card border-l-slate-400">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5">Down Payment</span>
                                            <span class="font-bold text-slate-800 text-xs" id="summaryDownPayment">$0</span>
                                        </div>
                                        
                                        <!-- Total Interest -->
                                        <div class="stat-card border-l-[#428bca]">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5">Total Interest</span>
                                            <span class="font-bold text-slate-800 text-xs" id="summaryTotalInterest">$0</span>
                                        </div>
                                        
                                        <!-- Total Principal & Int. -->
                                        <div class="stat-card border-l-[#428bca]">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5" id="summaryTotalLabel">Total Principal & Int.</span>
                                            <span class="font-bold text-slate-800 text-xs" id="summaryTotalPayments">$0</span>
                                        </div>
                                        
                                        <!-- Total Tax -->
                                        <div class="stat-card border-l-[#96c03b]">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5">Total Tax</span>
                                            <span class="font-bold text-slate-800 text-xs" id="summaryTotalTax">$0</span>
                                        </div>

                                        <!-- Total Insurance -->
                                        <div class="stat-card border-l-[#a90000]">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5">Total Insurance</span>
                                            <span class="font-bold text-slate-800 text-xs" id="summaryTotalIns">$0</span>
                                        </div>

                                        <!-- Total PMI/Fees -->
                                        <div class="stat-card border-l-[#d9534f]">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5">Total PMI / Fees</span>
                                            <span class="font-bold text-slate-800 text-xs"><span id="summaryTotalPMI">$0</span> / <span id="summaryTotalHOA">$0</span></span>
                                        </div>
                                        
                                        <!-- All-in Cost -->
                                        <div class="stat-card border-l-slate-800">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5 text-green-600">Total All-in Cost</span>
                                            <span class="font-bold text-slate-900 text-xs" id="summaryTotalAllIn">$0</span>
                                        </div>

                                        <!-- Payoff Date -->
                                        <div class="stat-card border-l-[#518428]">
                                            <span class="text-[9px] text-slate-500 font-medium uppercase tracking-wide mb-0.5">Payoff Date</span>
                                            <span class="font-bold text-[#518428] text-xs" id="summaryPayoffDate">-</span>
                                        </div>

                                        <!-- Hidden House Price -->
                                        <span id="summaryHousePrice" class="hidden"></span>
                                    </div>
                                </div>

                                <!-- 4. AMORTIZATION TOGGLE (Bottom Bar) -->
                                <button type="button" id="toggleTableBtn" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 hover:text-slate-900 border-t border-slate-200 py-2.5 px-4 transition-all duration-200 flex items-center justify-center gap-2 text-xs font-semibold group no-print">
                                    <i class="fa-solid fa-table-list text-slate-500 group-hover:text-slate-700"></i>
                                    <span>View Amortization Schedule</span>
                                    <i class="fa-solid fa-chevron-down text-[10px] ml-1 opacity-50 transition-transform group-hover:translate-y-0.5"></i>
                                </button>
                            </div>

                            <!-- Amortization Container (Hidden by default) -->
                            <div id="amortizationContainer" class="hidden rounded-lg border border-slate-200 bg-white p-0 shadow-lg overflow-hidden transition-all">
                                <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                                    <h3 class="text-sm font-bold text-slate-800">Amortization Schedule</h3>
                                    <button onclick="document.getElementById('amortizationContainer').classList.add('hidden')" class="text-slate-500 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                                <div class="overflow-x-auto slim-scroll max-h-96 bg-white">
                                    <table class="w-full min-w-[500px] text-left text-xs text-slate-700">
                                        <thead class="bg-slate-50 font-semibold text-slate-800 sticky top-0 shadow-sm z-10">
                                            <tr>
                                                <th class="px-4 py-3">Date</th>
                                                <th class="px-4 py-3">Interest</th>
                                                <th class="px-4 py-3">Principal</th>
                                                <th class="px-4 py-3 text-right">Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="amortizationBody" class="divide-y divide-slate-100">
                                            <!-- Rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Mobile Widget Placeholder (Visible only on mobile) -->
                    <div id="mobile-widget-placeholder" class="md:hidden mb-8"></div>

                    <!-- STRONG VISUAL SEPARATOR (Centralized) -->
                    <div class="calc-section-divider"></div>

                    <!-- SEO CONTENT (Full Width, Sectioned) -->
                    <div class="w-full max-w-[702px] no-print">
                        <div class="content-section">
                            <div class="bg-gradient-to-r from-brand-dark to-brand-red px-4 py-3 border-b border-white/10">
                                <h2 class="font-bold text-white">Mortgage Calculation Guide</h2>
                            </div>
                            <div class="p-5 text-xs text-slate-700 leading-relaxed grid grid-cols-1 gap-6">
                                
                                <!-- Introduction Section -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                        <i class="fa-solid fa-house-chimney text-[#518428]"></i> What is a Mortgage?
                                    </h3>
                                    <p class="mb-3">
                                        A mortgage is a loan specifically designed for purchasing a home or other real estate. The property itself serves as collateral for the loan. Buying a home is likely the biggest purchase of your life, and our free <strong>Mortgage Calculator</strong> helps you estimate your total monthly payment for 2025 and beyond.
                                    </p>
                                    <p>
                                        By factoring in property taxes, homeowners insurance, and PMI, you get a realistic picture of your true housing costs. <em>(Note: This tool is optimized for US fixed-rate loans.)</em> Use this tool to compare different loan scenarios, see how a larger down payment affects your wallet, and plan for a financially secure future. While primarily designed for US fixed-rate mortgages, the math works for any standard amortizing loan.
                                    </p>
                                </section>

                                <!-- FORMULA SECTION -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                        <i class="fa-solid fa-calculator text-[#518428]"></i> The Math Behind Your Mortgage
                                    </h3>
                                    <p class="mb-3">Curious about the numbers? Lenders use the standard amortization formula to determine your fixed monthly payment ($M$). It balances your principal ($P$), monthly interest rate ($r$), and the total number of months in your loan ($n$).</p>
                                    
                                    <div class="my-4 flex justify-center">
                                        <div class="bg-white px-6 py-3 rounded border border-slate-200 shadow-sm">
                                            <span class="font-serif text-lg text-slate-900 italic">
                                                M = P <span class="mx-1">&times;</span> 
                                                <span class="inline-block text-center align-middle">
                                                    <span class="block border-b border-slate-400 pb-0.5">r(1 + r)<sup>n</sup></span>
                                                    <span class="block pt-0.5">(1 + r)<sup>n</sup> &minus; 1</span>
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-[11px] text-slate-600 mt-2">
                                        <div class="flex items-center gap-2">
                                            <span class="font-serif font-bold italic text-slate-900 bg-slate-200 w-6 h-6 flex items-center justify-center rounded">M</span>
                                            <span>Monthly Payment</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-serif font-bold italic text-slate-900 bg-slate-200 w-6 h-6 flex items-center justify-center rounded">P</span>
                                            <span>Principal Loan Amount</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-serif font-bold italic text-slate-900 bg-slate-200 w-6 h-6 flex items-center justify-center rounded">r</span>
                                            <span>Monthly Interest Rate</span>
                                        </div>
                                    </div>
                                </section>

                                <!-- DEFINITIONS & FAQ GRID -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    
                                    <!-- Left: Understanding PITI -->
                                    <section class="info-card">
                                        <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                            <i class="fa-solid fa-list-check text-[#518428]"></i> What is PITI?
                                        </h3>
                                        <p class="mb-2">Lenders use the acronym <strong>PITI</strong> to describe the four main components of your monthly mortgage bill:</p>
                                        <ul class="space-y-3 mt-2">
                                            <li>
                                                <strong class="text-slate-800 block mb-0.5">Principal:</strong>
                                                The money that goes directly toward paying down your loan balance.
                                            </li>
                                            <li>
                                                <strong class="text-slate-800 block mb-0.5">Interest:</strong>
                                                The fee the lender charges you for borrowing the money. In the beginning, this makes up most of your payment.
                                            </li>
                                            <li>
                                                <strong class="text-slate-800 block mb-0.5">Taxes:</strong>
                                                Property taxes levied by your local government to fund schools and services. Lenders often collect this monthly.
                                            </li>
                                            <li>
                                                <strong class="text-slate-800 block mb-0.5">Insurance:</strong>
                                                Homeowners insurance protects your home from damage. If you put less than 20% down, this may also include <strong>PMI</strong> (Private Mortgage Insurance).
                                            </li>
                                        </ul>
                                    </section>

                                    <!-- Right: Strategies & Amortization -->
                                    <section class="flex flex-col gap-6">
                                        <div class="info-card">
                                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                                <i class="fa-solid fa-chart-line text-[#518428]"></i> The Amortization Schedule
                                            </h3>
                                            <p class="mb-2">Your <strong>amortization schedule</strong> shows the journey to being debt-free. In the early years, most of your money goes toward interest. Over time, the scales tip, and you start paying off the house (principal) faster.</p>
                                            <p>Use the "View Schedule" button above to see exactly when you'll cross the break-even point.</p>
                                        </div>

                                        <div class="info-card bg-green-50/50 border-green-100">
                                            <h3 class="font-bold text-[#518428] mb-1 flex items-center gap-2">
                                                <i class="fa-solid fa-lightbulb"></i> Smart Strategies
                                            </h3>
                                            <ul class="space-y-2 text-green-900 mt-2">
                                                <li><strong>Avoid PMI:</strong> A down payment of 20% or more typically removes the need for private mortgage insurance.</li>
                                                <li><strong>15 vs. 30 Year:</strong> A 30-year term offers lower monthly bills, while a 15-year term saves massive amounts on total interest.</li>
                                                <li><strong>Extra Payments:</strong> Even adding $50/month to your principal can shave years off your loan term.</li>
                                            </ul>
                                        </div>
                                    </section>
                                </div>

                                <!-- NEW GRID: Costs (Left) & Lower Payment (Right) - DENSIFIED (Using .feature-card) -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    
                                    <!-- Left: Costs of Ownership -->
                                    <section class="info-card !px-4 !py-3">
                                        <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2 text-sm">
                                            <i class="fa-solid fa-wallet text-[#518428]"></i> Costs of Ownership
                                        </h3>
                                        <p class="mb-3 text-[11px] text-slate-600 leading-tight">Budget for these often-overlooked expenses:</p>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                            <!-- Closing Costs -->
                                            <div class="feature-card">
                                                <div class="mt-0.5 text-brand-red"><i class="fa-solid fa-file-signature"></i></div>
                                                <div>
                                                    <strong class="text-slate-800 block mb-0.5 text-[11px]">Closing Costs</strong>
                                                    <span class="text-slate-600 text-[10px] leading-snug block">Expect to pay <span class="font-semibold text-slate-800">2% - 5%</span> of purchase price upfront ($8k-$20k on $400k).</span>
                                                </div>
                                            </div>
                                            <!-- Maintenance -->
                                            <div class="feature-card">
                                                <div class="mt-0.5 text-brand-red"><i class="fa-solid fa-screwdriver-wrench"></i></div>
                                                <div>
                                                    <strong class="text-slate-800 block mb-0.5 text-[11px]">Maintenance</strong>
                                                    <span class="text-slate-600 text-[10px] leading-snug block">Save <span class="font-semibold text-slate-800">1% - 3%</span> of home value annually for repairs ($4k/yr on $400k).</span>
                                                </div>
                                            </div>
                                            <!-- Utilities -->
                                            <div class="feature-card">
                                                <div class="mt-0.5 text-brand-red"><i class="fa-solid fa-faucet"></i></div>
                                                <div>
                                                    <strong class="text-slate-800 block mb-0.5 text-[11px]">Utilities</strong>
                                                    <span class="text-slate-600 text-[10px] leading-snug block">Avg. <span class="font-semibold text-slate-800">$400/mo</span> for electric, gas, water, trash & internet.</span>
                                                </div>
                                            </div>
                                            <!-- Furniture -->
                                            <div class="feature-card">
                                                <div class="mt-0.5 text-brand-red"><i class="fa-solid fa-couch"></i></div>
                                                <div>
                                                    <strong class="text-slate-800 block mb-0.5 text-[11px]">Furnishing</strong>
                                                    <span class="text-slate-600 text-[10px] leading-snug block">New owners spend <span class="font-semibold text-slate-800">10% - 25%</span> of home value on decor & upgrades.</span>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <!-- Right: How to Lower Payment -->
                                    <section class="info-card !px-4 !py-3">
                                        <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2 text-sm">
                                            <i class="fa-solid fa-arrow-trend-down text-[#518428]"></i> Lower Your Payment
                                        </h3>
                                        <p class="mb-3 text-[11px] text-slate-600 leading-tight">Proven strategies to reduce monthly costs:</p>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                            <div class="feature-card">
                                                <div class="mt-0.5 text-green-600"><i class="fa-solid fa-circle-check"></i></div>
                                                <div>
                                                    <strong class="text-slate-800 block mb-0.5 text-[11px]">More Down Payment</strong>
                                                    <span class="text-slate-600 text-[10px] leading-snug block">Every <span class="font-semibold text-slate-800">$10k</span> down saves ~$60/mo in interest & principle.</span>
                                                </div>
                                            </div>
                                            <div class="feature-card">
                                                <div class="mt-0.5 text-green-600"><i class="fa-solid fa-circle-check"></i></div>
                                                <div>
                                                    <strong class="text-slate-800 block mb-0.5 text-[11px]">Eliminate PMI</strong>
                                                    <span class="text-slate-600 text-[10px] leading-snug block">Reach <span class="font-semibold text-slate-800">20% equity</span> to drop insurance ($30-$70/mo per $100k).</span>
                                                </div>
                                            </div>
                                            <div class="feature-card">
                                                <div class="mt-0.5 text-green-600"><i class="fa-solid fa-circle-check"></i></div>
                                                <div>
                                                    <strong class="text-slate-800 block mb-0.5 text-[11px]">Shop Insurance</strong>
                                                    <span class="text-slate-600 text-[10px] leading-snug block">Rates vary by <span class="font-semibold text-slate-800">hundreds</span>. Compare quotes annually to save.</span>
                                                </div>
                                            </div>
                                            <div class="feature-card">
                                                <div class="mt-0.5 text-green-600"><i class="fa-solid fa-circle-check"></i></div>
                                                <div>
                                                    <strong class="text-slate-800 block mb-0.5 text-[11px]">Recast Loan</strong>
                                                    <span class="text-slate-600 text-[10px] leading-snug block">Pay lump sum <span class="font-semibold text-slate-800">($5k+)</span> to lower monthly bill without refi fees.</span>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                </div>

                                <!-- NEW SECTION: Common Terms -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-book-open text-[#518428]"></i> Common Mortgage Terms Explained
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-white p-3 rounded border border-slate-200">
                                            <strong class="text-brand-dark block mb-1">LTV (Loan-to-Value)</strong>
                                            <p class="text-slate-600">The ratio of your loan amount to the home's value. Lenders use this to determine risk. <strong>Tip:</strong> keeping LTV under 80% usually avoids PMI.</p>
                                        </div>
                                        <div class="bg-white p-3 rounded border border-slate-200">
                                            <strong class="text-brand-dark block mb-1">DTI (Debt-to-Income)</strong>
                                            <p class="text-slate-600">The percentage of your gross monthly income that goes to paying debts. Most lenders prefer a DTI under 36%.</p>
                                        </div>
                                        <div class="bg-white p-3 rounded border border-slate-200">
                                            <strong class="text-brand-dark block mb-1">Escrow Account</strong>
                                            <p class="text-slate-600">A savings account managed by your lender. A portion of your monthly payment goes here to pay your property taxes and insurance when they are due.</p>
                                        </div>
                                        <div class="bg-white p-3 rounded border border-slate-200">
                                            <strong class="text-brand-dark block mb-1">Fixed vs. Adjustable Rate</strong>
                                            <p class="text-slate-600"><strong>Fixed:</strong> Rate stays the same forever. <br><strong>Adjustable (ARM):</strong> Rate changes after a set period based on market conditions.</p>
                                        </div>
                                    </div>
                                </section>

                                <!-- NEW SECTION: FAQ -->
                                <section class="info-card">
                                    <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-circle-question text-[#518428]"></i> Frequently Asked Questions
                                    </h3>
                                    <div class="space-y-4">
                                        <!-- Q1 -->
                                        <div class="flex gap-3 items-start">
                                            <div class="flex-shrink-0 w-5 h-5 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-[10px] font-bold border border-slate-200 mt-0.5">1</div>
                                            <div>
                                                <h4 class="text-[12px] font-bold text-brand-dark mb-1 leading-tight">Do I really need a 20% down payment?</h4>
                                                <p class="text-xs text-slate-600">No. While 20% avoids Private Mortgage Insurance (PMI), many lenders accept as little as 3% - 3.5% for conventional or FHA loans. However, a lower down payment usually means a higher monthly payment.</p>
                                            </div>
                                        </div>
                                        <!-- Q2 -->
                                        <div class="flex gap-3 items-start">
                                            <div class="flex-shrink-0 w-5 h-5 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-[10px] font-bold border border-slate-200 mt-0.5">2</div>
                                            <div>
                                                <h4 class="text-[12px] font-bold text-brand-dark mb-1 leading-tight">What is included in my monthly payment?</h4>
                                                <p class="text-xs text-slate-600">Your total payment typically includes Principal and Interest (the loan itself), plus Escrow items like Property Taxes and Homeowners Insurance. If your down payment is under 20%, it may also include PMI.</p>
                                            </div>
                                        </div>
                                        <!-- Q3 -->
                                        <div class="flex gap-3 items-start">
                                            <div class="flex-shrink-0 w-5 h-5 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-[10px] font-bold border border-slate-200 mt-0.5">3</div>
                                            <div>
                                                <h4 class="text-[12px] font-bold text-brand-dark mb-1 leading-tight">How can I pay off my mortgage faster?</h4>
                                                <p class="text-xs text-slate-600">Making extra payments toward your <em>principal</em> balance reduces total interest. Even one extra payment per year can shave years off a 30-year term. Use the "More Options" section above to test this strategy.</p>
                                            </div>
                                        </div>
                                         <!-- Q4 -->
                                        <div class="flex gap-3 items-start">
                                            <div class="flex-shrink-0 w-5 h-5 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-[10px] font-bold border border-slate-200 mt-0.5">4</div>
                                            <div>
                                                <h4 class="text-[12px] font-bold text-brand-dark mb-1 leading-tight">What is a "good" interest rate?</h4>
                                                <p class="text-xs text-slate-600">Rates fluctuate daily based on the economy and your credit score. Generally, a score above 740 secures the lowest rates. Compare quotes from at least 3 lenders to ensure you aren't overpaying.</p>
                                            </div>
                                        </div>
                                        <!-- Q5 -->
                                        <div class="flex gap-3 items-start">
                                            <div class="flex-shrink-0 w-5 h-5 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-[10px] font-bold border border-slate-200 mt-0.5">5</div>
                                            <div>
                                                <h4 class="text-[12px] font-bold text-brand-dark mb-1 leading-tight">Should I choose a 15-year or 30-year term?</h4>
                                                <p class="text-xs text-slate-600">A 30-year loan offers lower monthly payments, making it easier to qualify. A 15-year loan has higher monthly payments but saves you tens of thousands of dollars in interest over the life of the loan.</p>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT SIDEBAR (Sticky) -->
                <div class="w-full shrink-0 space-y-4 lg:w-[300px] no-print">
                    
                    <!-- NEW: Desktop Widget Placeholder (Hidden on mobile) -->
                    <!-- Renamed from 'sidebar-widget-container' to be explicit, though I will update JS to handle both or fallback -->
                    <div id="desktop-widget-placeholder" class="hidden md:block"></div>
                    <!-- Kept old ID for safety if JS isn't fully updated yet, but intended to be replaced by logic -->
                    
                    <div class="ad-box"><span class="text-xs font-semibold text-slate-400">ADVERTISEMENT<br>300x250</span></div>
                    
                    <!-- NEW SECTION: Mortgage Checklist -->
                    <div class="content-section">
                        <div class="bg-gradient-to-r from-brand-dark to-brand-red px-4 py-2">
                            <h3 class="font-bold text-white text-center">Mortgage Readiness Checklist</h3>
                        </div>
                        <div class="p-4 text-xs text-slate-600">
                            <p class="mb-3 font-medium text-slate-700">Have these ready before you apply:</p>
                            <ul class="space-y-3">
                                <li class="flex gap-2 items-start">
                                    <i class="fa-solid fa-check-circle text-green-600 text-sm mt-0.5"></i>
                                    <span><strong>Proof of Income:</strong> Recent pay stubs & W-2s (last 2 years).</span>
                                </li>
                                <li class="flex gap-2 items-start">
                                    <i class="fa-solid fa-check-circle text-green-600 text-sm mt-0.5"></i>
                                    <span><strong>Credit Report:</strong> Check for errors. Score > 620 is ideal.</span>
                                </li>
                                <li class="flex gap-2 items-start">
                                    <i class="fa-solid fa-check-circle text-green-600 text-sm mt-0.5"></i>
                                    <span><strong>Asset Statements:</strong> 60 days of bank statements for down payment.</span>
                                </li>
                                <li class="flex gap-2 items-start">
                                    <i class="fa-solid fa-check-circle text-green-600 text-sm mt-0.5"></i>
                                    <span><strong>Debt List:</strong> Student loans, auto loans, and credit cards.</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- DYNAMIC SIDEBAR WIDGET -->
                    <!-- The content inside this div is now populated by js/global.js based on the data-category -->
                    <div class="content-section sticky top-4" data-widget="related-tools" data-category="Finance">
                        <!-- Loading State (replaced immediately by JS) -->
                        <div class="p-4 text-center text-slate-400 text-xs">
                            <i class="fa-solid fa-spinner fa-spin mb-2"></i><br>Loading tools...
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="footer-placeholder" class="no-print"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentAmortizationData = [];
            const inputs = {
                homePrice: document.getElementById('homePrice'),
                downPaymentInput: document.getElementById('downPaymentInput'),
                downPaymentType: document.getElementById('downPaymentType'),
                loanTerm: document.getElementById('loanTermInput'),
                interestRate: document.getElementById('interestRate'),
                startMonth: document.getElementById('startMonth'),
                startYear: document.getElementById('startYear'),
                includeTaxesCosts: document.getElementById('includeTaxesCosts'),
                dynamicCostsContainer: document.getElementById('dynamicCostsContainer'),
                propertyTax: document.getElementById('propertyTax'),
                propertyTaxType: document.getElementById('propertyTaxType'),
                homeInsurance: document.getElementById('homeInsurance'),
                homeInsuranceType: document.getElementById('homeInsuranceType'),
                pmi: document.getElementById('pmi'),
                pmiType: document.getElementById('pmiType'),
                hoaFees: document.getElementById('hoaFees'),
                hoaFeesType: document.getElementById('hoaFeesType'),
                otherCosts: document.getElementById('otherCosts'),
                otherCostsType: document.getElementById('otherCostsType'),
                toggleMoreOptions: document.getElementById('toggleMoreOptions'),
                moreOptionsContainer: document.getElementById('moreOptionsContainer'),
                taxIncrease: document.getElementById('taxIncrease'),
                insIncrease: document.getElementById('insIncrease'),
                hoaIncrease: document.getElementById('hoaIncrease'),
                otherIncrease: document.getElementById('otherIncrease'), 
                extraMonthly: document.getElementById('extraMonthly'),
                extraMonthlyMonth: document.getElementById('extraMonthlyMonth'),
                extraYearly: document.getElementById('extraYearly'),
                extraYearlyMonth: document.getElementById('extraYearlyMonth'),
                oneTimeContainer: document.getElementById('oneTimePaymentsContainer'),
                addOneTimeBtn: document.getElementById('addOneTimePaymentBtn'),
            };

            const display = {
                monthlyTotal: document.getElementById('monthlyPaymentDisplay'),
                breakdownPI: document.getElementById('breakdownPI'),
                breakdownTax: document.getElementById('breakdownTax'),
                breakdownIns: document.getElementById('breakdownIns'),
                breakdownPMI: document.getElementById('breakdownPMI'),
                breakdownHOA: document.getElementById('breakdownHOA'),
                breakdownTotal: document.getElementById('breakdownTotal'), 
                housePrice: document.getElementById('summaryHousePrice'),
                loanAmount: document.getElementById('summaryLoanAmount'),
                downPayment: document.getElementById('summaryDownPayment'),
                totalPaymentsLabel: document.getElementById('summaryTotalLabel'),
                totalPayments: document.getElementById('summaryTotalPayments'),
                totalInterest: document.getElementById('summaryTotalInterest'),
                payoffDate: document.getElementById('summaryPayoffDate'),
                amortizationBody: document.getElementById('amortizationBody'),
                totalTax: document.getElementById('summaryTotalTax'),
                totalIns: document.getElementById('summaryTotalIns'),
                totalPMI: document.getElementById('summaryTotalPMI'),
                totalHOA: document.getElementById('summaryTotalHOA'),
                totalAllIn: document.getElementById('summaryTotalAllIn')
            };

            const chartRings = {
                principal: document.getElementById('chartRingPrincipal'),
                tax: document.getElementById('chartRingTax'),
                ins: document.getElementById('chartRingIns'),
                pmi: document.getElementById('chartRingPMI'),
                hoa: document.getElementById('chartRingHOA')
            };

            const tooltip = document.getElementById('chartTooltip');

            const d = new Date();
            inputs.startYear.value = d.getFullYear();
            inputs.startMonth.value = d.getMonth();
            document.querySelector('.otp-year').value = d.getFullYear() + 1;

            // --- EVENT LISTENERS FOR INPUTS ---
            
            inputs.includeTaxesCosts.addEventListener('change', () => {
                if (inputs.includeTaxesCosts.checked) {
                    inputs.dynamicCostsContainer.classList.remove('h-0', 'opacity-0', 'mb-0');
                    inputs.dynamicCostsContainer.classList.add('mb-2');
                } else {
                    inputs.dynamicCostsContainer.classList.add('h-0', 'opacity-0', 'mb-0');
                    inputs.dynamicCostsContainer.classList.remove('mb-2');
                }
                calculate();
            });

            inputs.toggleMoreOptions.addEventListener('click', () => {
                inputs.moreOptionsContainer.classList.toggle('hidden');
                const isHidden = inputs.moreOptionsContainer.classList.contains('hidden');
                inputs.toggleMoreOptions.textContent = isHidden ? '+ More Options (Increases & Extra Pay)' : '- Less Options';
            });

            inputs.addOneTimeBtn.addEventListener('click', () => {
                const newRow = document.createElement('div');
                newRow.className = 'one-time-payment-row border-t border-slate-100 pt-2 mt-2 relative';
                // A11Y FIX: Added aria-label and placeholder-slate-500 to new dynamic rows
                newRow.innerHTML = `<button type="button" class="remove-otp absolute -right-2 -top-2 text-red-400 hover:text-red-600 text-xs font-bold px-1" aria-label="Remove payment">&times;</button><div class="flex gap-1 mb-1"><div class="relative w-full"><span class="absolute left-1.5 top-1 text-[10px] text-slate-400">$</span><input type="number" aria-label="One-time payment amount" class="compact-input pl-4 otp-amount" value="0"></div></div><div class="flex gap-1"><span class="text-[10px] self-center text-slate-400">in</span><select class="compact-select w-[45%] otp-month" aria-label="One-time payment month"><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option></select><input type="number" aria-label="One-time payment year" class="compact-input w-[35%] otp-year placeholder-slate-500" placeholder="Year" value="${parseInt(document.querySelector('.otp-year').value) + 1}"></div>`;
                inputs.oneTimeContainer.appendChild(newRow);
                newRow.querySelectorAll('input, select').forEach(el => el.addEventListener('input', calculate));
                newRow.querySelector('.remove-otp').addEventListener('click', () => { newRow.remove(); calculate(); });
            });

            inputs.downPaymentType.addEventListener('change', () => {
                const price = parseFloat(inputs.homePrice.value) || 0;
                const currentVal = parseFloat(inputs.downPaymentInput.value) || 0;
                const newType = inputs.downPaymentType.value;

                if (newType === '$') {
                    const dollarAmount = (currentVal / 100) * price;
                    inputs.downPaymentInput.value = Math.round(dollarAmount);
                } else {
                    const percent = price > 0 ? (currentVal / price) * 100 : 0;
                    inputs.downPaymentInput.value = percent.toFixed(2);
                }
                calculate();
            });

            // --- CORE CALCULATION FUNCTION ---
            function calculate() {
                const homePrice = parseFloat(inputs.homePrice.value) || 0;
                
                let downPayment = 0;
                let dpValue = parseFloat(inputs.downPaymentInput.value) || 0;
                if (inputs.downPaymentType.value === '%') {
                    downPayment = (dpValue / 100) * homePrice;
                } else {
                    downPayment = dpValue;
                }

                const loanAmount = Math.max(0, homePrice - downPayment);
                const termYears = parseFloat(inputs.loanTerm.value) || 30;
                const annualRate = parseFloat(inputs.interestRate.value) || 0;
                const monthlyRate = (annualRate / 100) / 12;
                const totalMonths = Math.round(termYears * 12);
                const startM = parseInt(inputs.startMonth.value);
                const startY = parseInt(inputs.startYear.value) || new Date().getFullYear();
                const startDate = new Date(startY, startM);

                const includeCosts = inputs.includeTaxesCosts.checked;

                let taxYear = 0, insYear = 0, pmiYear = 0, hoaMonth = 0, otherMonth = 0;

                if (includeCosts) {
                    let taxValue = parseFloat(inputs.propertyTax.value) || 0;
                    let taxType = inputs.propertyTaxType.value; 
                    taxYear = (taxType === '%') ? (taxValue / 100) * homePrice : taxValue;

                    let insValue = parseFloat(inputs.homeInsurance.value) || 0;
                    let insType = inputs.homeInsuranceType.value;
                    insYear = (insType === '%') ? (insValue / 100) * homePrice : insValue;

                    let pmiValue = parseFloat(inputs.pmi.value) || 0;
                    let pmiType = inputs.pmiType.value;
                    pmiYear = (pmiType === '%') ? (pmiValue / 100) * loanAmount : pmiValue;

                    let hoaValue = parseFloat(inputs.hoaFees.value) || 0;
                    let hoaType = inputs.hoaFeesType.value;
                    hoaMonth = (hoaType === '%') ? (hoaValue / 100) * homePrice : hoaValue;

                    let otherValue = parseFloat(inputs.otherCosts.value) || 0;
                    let otherType = inputs.otherCostsType.value;
                    otherMonth = (otherType === '%') ? (otherValue / 100) * homePrice : otherValue;
                }

                let totalOtherMonth = hoaMonth + otherMonth;

                const taxIncPct = (parseFloat(inputs.taxIncrease.value) || 0) / 100;
                const insIncPct = (parseFloat(inputs.insIncrease.value) || 0) / 100;
                const hoaIncPct = (parseFloat(inputs.hoaIncrease.value) || 0) / 100;
                const otherIncPct = (parseFloat(inputs.otherIncrease.value) || 0) / 100;
                const extMonthlyAmt = parseFloat(inputs.extraMonthly.value) || 0;
                const extMonthlyStartM = parseInt(inputs.extraMonthlyMonth.value);
                const extYearlyAmt = parseFloat(inputs.extraYearly.value) || 0;
                const extYearlyMonth = parseInt(inputs.extraYearlyMonth.value); 
                const oneTimePayments = [];
                document.querySelectorAll('.one-time-payment-row').forEach(row => {
                    const amt = parseFloat(row.querySelector('.otp-amount').value) || 0;
                    if (amt > 0) {
                        oneTimePayments.push({
                            amount: amt,
                            month: parseInt(row.querySelector('.otp-month').value),
                            year: parseInt(row.querySelector('.otp-year').value)
                        });
                    }
                });
                let basePI = 0;
                if (annualRate === 0) basePI = loanAmount / totalMonths;
                else basePI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / (Math.pow(1 + monthlyRate, totalMonths) - 1);
                if(!isFinite(basePI)) basePI = 0;

                let balance = loanAmount;
                let accInterest = 0;
                let finalPayoffDate = new Date(startDate);
                let monthCount = 0;
                let schedule = [];
                let currentD = new Date(startDate);
                
                let accTax = 0;
                let accIns = 0;
                let accPMI = 0;
                let accHOA = 0;

                while (balance > 0.01 && monthCount < 720) {
                    monthCount++;
                    if (monthCount > 1 && (monthCount - 1) % 12 === 0) {
                        if (includeCosts) {
                            taxYear *= (1 + taxIncPct);
                            insYear *= (1 + insIncPct);
                            hoaMonth *= (1 + hoaIncPct); 
                            otherMonth *= (1 + otherIncPct);
                        }
                    }
                    const interestPayment = balance * monthlyRate;
                    accInterest += interestPayment;
                    let principalPayment = basePI - interestPayment;
                    let extMonStartDate = new Date(startY, extMonthlyStartM);
                    if (currentD >= extMonStartDate) principalPayment += extMonthlyAmt;
                    if (currentD.getMonth() === extYearlyMonth) principalPayment += extYearlyAmt;
                    oneTimePayments.forEach(otp => {
                        if (currentD.getMonth() === otp.month && currentD.getFullYear() === otp.year) principalPayment += otp.amount;
                    });
                    if (principalPayment > balance) principalPayment = balance;
                    balance -= principalPayment;
                    
                    if (includeCosts) {
                        accTax += taxYear / 12;
                        accIns += insYear / 12;
                        if ((balance / homePrice) > 0.8) {
                            accPMI += pmiYear / 12;
                        }
                        accHOA += (hoaMonth + otherMonth);
                    }

                    if (monthCount % 12 === 0 || balance <= 0.01) {
                        schedule.push({year: currentD.getFullYear(), interest: accInterest, balance: balance});
                    }
                    currentD.setMonth(currentD.getMonth() + 1);
                }
                finalPayoffDate = new Date(currentD);
                finalPayoffDate.setMonth(finalPayoffDate.getMonth() - 1); 
                
                let startTaxYear = (inputs.propertyTaxType.value === '%') ? (parseFloat(inputs.propertyTax.value)/100)*homePrice : parseFloat(inputs.propertyTax.value);
                let startInsYear = (inputs.homeInsuranceType.value === '%') ? (parseFloat(inputs.homeInsurance.value)/100)*homePrice : parseFloat(inputs.homeInsurance.value);
                let startPmiYear = (inputs.pmiType.value === '%') ? (parseFloat(inputs.pmi.value)/100)*loanAmount : parseFloat(inputs.pmi.value);
                let startHoaMonth = (inputs.hoaFeesType.value === '%') ? (parseFloat(inputs.hoaFees.value)/100)*homePrice : parseFloat(inputs.hoaFees.value);
                let startOtherMonth = (inputs.otherCostsType.value === '%') ? (parseFloat(inputs.otherCosts.value)/100)*homePrice : parseFloat(inputs.otherCosts.value);
                
                if (!includeCosts) {
                    startTaxYear = 0; startInsYear = 0; startPmiYear = 0; startHoaMonth = 0; startOtherMonth = 0;
                }

                const displayTax = startTaxYear / 12;
                const displayIns = startInsYear / 12;
                const displayPMI = startPmiYear / 12;
                const displayHOA = startHoaMonth + startOtherMonth;
                const initTotal = basePI + displayTax + displayIns + displayPMI + displayHOA;
                
                const totalPaid = loanAmount + accInterest;
                const totalAllIn = totalPaid + accTax + accIns + accPMI + accHOA;

                updateDisplay(basePI, displayTax, displayIns, displayPMI, displayHOA, initTotal, homePrice, downPayment, loanAmount, totalPaid, accInterest, finalPayoffDate, totalMonths, accTax, accIns, accPMI, accHOA, totalAllIn);
                updateChart(basePI, displayTax, displayIns, displayPMI, displayHOA, initTotal);
                updateAmortizationTable(schedule, loanAmount); 
                saveToHistory(homePrice, annualRate, initTotal);
            }

            // --- HELPER FUNCTIONS ---

            function updateDisplay(pi, tax, ins, pmi, hoa, total, housePrice, downPayment, loan, totalPaid, interest, payoffDate, totalMonths, totalTax, totalIns, totalPMI, totalHOA, totalAllIn) {
                const fmt = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
                const fmtCents = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
                display.monthlyTotal.textContent = fmtCents(total);
                display.breakdownPI.textContent = fmtCents(pi);
                display.breakdownTax.textContent = fmtCents(tax);
                display.breakdownIns.textContent = fmtCents(ins);
                display.breakdownPMI.textContent = fmtCents(pmi);
                display.breakdownHOA.textContent = fmtCents(hoa);
                display.breakdownTotal.textContent = fmtCents(total);
                display.housePrice.textContent = fmt(housePrice);
                display.loanAmount.textContent = fmt(loan);
                display.downPayment.textContent = fmt(downPayment);
                display.totalPaymentsLabel.textContent = `Total Principal & Int.`;
                display.totalPayments.textContent = fmt(totalPaid);
                display.totalInterest.textContent = fmt(interest);
                display.payoffDate.textContent = payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                if(display.totalTax) display.totalTax.textContent = fmt(totalTax);
                if(display.totalIns) display.totalIns.textContent = fmt(totalIns);
                if(display.totalPMI) display.totalPMI.textContent = fmt(totalPMI);
                if(display.totalHOA) display.totalHOA.textContent = fmt(totalHOA);
                if(display.totalAllIn) display.totalAllIn.textContent = fmt(totalAllIn);
            }

            function updateChart(pi, tax, ins, pmi, hoa, total) {
                if (total <= 0) return;
                const getPct = (val) => (val / total) * 100;
                const pctPI = getPct(pi);
                const pctTax = getPct(tax);
                const pctIns = getPct(ins);
                const pctPMI = getPct(pmi);
                const pctHOA = getPct(hoa);
                const setSegment = (el, pct, offset) => {
                    const val = Math.max(0, pct);
                    if (val < 0.1) el.style.opacity = '0';
                    else {
                        el.style.opacity = '1';
                        el.setAttribute('stroke-dasharray', `${val} ${100 - val}`);
                        el.setAttribute('stroke-dashoffset', -offset);
                    }
                };
                let offset = 0;
                setSegment(chartRings.principal, pctPI, offset); offset += pctPI;
                setSegment(chartRings.tax, pctTax, offset); offset += pctTax;
                setSegment(chartRings.ins, pctIns, offset); offset += pctIns;
                setSegment(chartRings.pmi, pctPMI, offset); offset += pctPMI;
                setSegment(chartRings.hoa, pctHOA, offset);
            }

            const labels = { principal: 'Principal & Int.', tax: 'Property Tax', ins: 'Home Insurance', pmi: 'PMI', hoa: 'HOA / Other' };
            
            // Colors map for Dynamic Tooltip
            const segmentStyles = {
                principal: { bg: '#428bca', text: '#ffffff' },
                tax: { bg: '#96c03b', text: '#ffffff' },
                ins: { bg: '#a90000', text: '#ffffff' },
                pmi: { bg: '#d9534f', text: '#ffffff' },
                hoa: { bg: '#30add1', text: '#ffffff' }
            };

            function highlightSegment(id) {
                Object.values(chartRings).forEach(s => s.style.opacity = '0.3');
                const active = document.querySelector(`.chart-segment[data-id="${id}"]`);
                if(active) { active.style.opacity = '1'; active.style.strokeWidth = '12'; }
                document.querySelectorAll('#resultTable div[data-legend-for]').forEach(r => r.classList.remove('bg-slate-200')); 
                const activeRow = document.querySelector(`#resultTable div[data-legend-for="${id}"]`);
                if(activeRow) activeRow.classList.add('bg-slate-200');
            }

            function resetHighlight() {
                Object.values(chartRings).forEach(s => { s.style.opacity = '1'; s.style.strokeWidth = '8'; });
                document.querySelectorAll('#resultTable div[data-legend-for]').forEach(r => r.classList.remove('bg-slate-200'));
            }

            // --- TOOLTIP LOGIC ---
            document.querySelectorAll('.chart-segment').forEach(seg => {
                seg.addEventListener('mouseenter', (e) => {
                    const id = seg.dataset.id;
                    highlightSegment(id);
                    
                    if (tooltip) {
                        const style = segmentStyles[id];
                        if (style) {
                            tooltip.style.backgroundColor = style.bg;
                            tooltip.style.color = style.text;
                            tooltip.style.borderColor = style.bg; // Match border to bg
                        }

                        const valEl = document.getElementById(id === 'principal' ? 'breakdownPI' : id === 'tax' ? 'breakdownTax' : id === 'ins' ? 'breakdownIns' : id === 'pmi' ? 'breakdownPMI' : 'breakdownHOA');
                        if (valEl) {
                            // Note: Removed 'text-slate-300' classes inside since we force text color via style above
                            tooltip.innerHTML = `<div class="font-bold text-[11px] opacity-90 mb-0.5">${labels[id]}</div><div class="text-sm font-bold drop-shadow-sm">${valEl.textContent}</div>`;
                            tooltip.classList.remove('opacity-0');
                        }
                    }
                });

                seg.addEventListener('mousemove', (e) => {
                    if (tooltip) {
                        tooltip.style.left = e.clientX + 'px';
                        tooltip.style.top = e.clientY + 'px';
                    }
                });

                seg.addEventListener('mouseleave', () => {
                    resetHighlight();
                    if (tooltip) tooltip.classList.add('opacity-0');
                });
            });

            document.querySelectorAll('#resultTable div[data-legend-for]').forEach(row => {
                row.addEventListener('mouseenter', () => highlightSegment(row.dataset.legendFor));
                row.addEventListener('mouseleave', resetHighlight);
            });

            function updateAmortizationTable(schedule, initialLoan) {
                currentAmortizationData = []; // Reset current data
                let html = '';
                let prevInterest = 0;
                let prevBalance = initialLoan;
                
                schedule.forEach(item => {
                    const yearInterest = item.interest - prevInterest;
                    const yearPrincipal = prevBalance - item.balance;
                    
                    // Capture data for CSV
                    currentAmortizationData.push({
                        year: item.year,
                        interest: Math.round(yearInterest),
                        principal: Math.round(yearPrincipal),
                        balance: Math.round(item.balance)
                    });

                    html += `<tr class="hover:bg-slate-50 transition-colors"><td class="px-4 py-3 font-medium text-slate-800">${item.year}</td><td class="px-4 py-3 text-slate-600">$${Math.round(yearInterest).toLocaleString()}</td><td class="px-4 py-3 text-slate-600">$${Math.round(yearPrincipal).toLocaleString()}</td><td class="px-4 py-3 text-right font-medium text-slate-800">$${Math.round(item.balance).toLocaleString()}</td></tr>`;
                    prevInterest = item.interest;
                    prevBalance = item.balance;
                });
                display.amortizationBody.innerHTML = html;
            }

            // --- SAVE / SHARE / DOWNLOAD / HISTORY ---
            document.getElementById('saveBtn').addEventListener('click', () => {
                const presetName = prompt("Name this calculation (e.g., 'Dream House 2025'):");
                if (presetName) {
                    const preset = { name: presetName, date: new Date().toISOString(), inputs: `$${parseFloat(inputs.homePrice.value).toLocaleString()} Home, ${inputs.interestRate.value}% Rate`, calculator: 'Mortgage Calculator', url: window.location.href };
                    let allPresets = JSON.parse(localStorage.getItem('dailyCalcPresets')) || {};
                    if (!allPresets['Mortgage Calculator']) allPresets['Mortgage Calculator'] = [];
                    allPresets['Mortgage Calculator'].push(preset);
                    localStorage.setItem('dailyCalcPresets', JSON.stringify(allPresets));
                    const btn = document.getElementById('saveBtn');
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = `<i class="fa-solid fa-check text-green-600"></i>`;
                    setTimeout(() => btn.innerHTML = originalHtml, 2000);
                }
            });

            // NEW: Download CSV Logic
            document.getElementById('downloadCsvBtn').addEventListener('click', () => {
                if (!currentAmortizationData || currentAmortizationData.length === 0) {
                    alert('Please calculate first.');
                    return;
                }

                const headers = ['Year', 'Interest Paid', 'Principal Paid', 'Remaining Balance'];
                const csvContent = [
                    headers.join(','),
                    ...currentAmortizationData.map(row => 
                        `${row.year},${row.interest},${row.principal},${row.balance}`
                    )
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'Mortgage_Schedule.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Feedback
                const btn = document.getElementById('downloadCsvBtn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="fa-solid fa-check text-green-600"></i>`;
                setTimeout(() => btn.innerHTML = originalHtml, 2000);
            });

            // UPDATED: Use global HistoryManager
            let historyDebounce;
            function saveToHistory(price, rate, monthly) {
                clearTimeout(historyDebounce);
                historyDebounce = setTimeout(() => {
                    if (price < 1000 || monthly <= 0) return;
                    
                    // Call the new global manager
                    if (window.HistoryManager) {
                        window.HistoryManager.save(
                            'Mortgage Calculator',
                            `$${price.toLocaleString()} @ ${rate}%`,
                            `$${monthly.toLocaleString(undefined, {maximumFractionDigits: 2})}/mo`
                        );
                    }
                }, 4000); 
            }

            document.getElementById('shareBtn').addEventListener('click', () => {
                const params = new URLSearchParams();
                params.set('price', inputs.homePrice.value);
                params.set('dp_amt', inputs.downPaymentInput.value); 
                params.set('dp_type', inputs.downPaymentType.value); 
                params.set('term', inputs.loanTerm.value);
                params.set('rate', inputs.interestRate.value);
                params.set('tax', inputs.propertyTax.value);
                params.set('ins', inputs.homeInsurance.value);
                params.set('pmi', inputs.pmi.value);
                params.set('hoa', inputs.hoaFees.value);
                if (inputs.extraMonthly.value > 0) params.set('em', inputs.extraMonthly.value);
                const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => { showCopySuccess(); }).catch(() => { fallbackCopy(shareUrl); });
                } else { fallbackCopy(shareUrl); }
            });
            function fallbackCopy(text) {
                const tempInput = document.getElementById('shareUrlInput');
                tempInput.value = text;
                tempInput.classList.remove('hidden');
                tempInput.select();
                try { document.execCommand('copy'); showCopySuccess(); } catch (err) { prompt("Copy this link to share:", text); }
                tempInput.classList.add('hidden');
            }
            function showCopySuccess() {
                const btn = document.getElementById('shareBtn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="fa-solid fa-check text-green-600"></i>`;
                setTimeout(() => btn.innerHTML = originalHtml, 2000);
            }
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('price')) {
                inputs.homePrice.value = urlParams.get('price');
                if (urlParams.has('dp_amt')) inputs.downPaymentInput.value = urlParams.get('dp_amt');
                if (urlParams.has('dp_type')) inputs.downPaymentType.value = urlParams.get('dp_type');
                if (urlParams.has('term')) inputs.loanTerm.value = urlParams.get('term');
                if (urlParams.has('rate')) inputs.interestRate.value = urlParams.get('rate');
                if (urlParams.has('tax')) inputs.propertyTax.value = urlParams.get('tax');
                if (urlParams.has('ins')) inputs.homeInsurance.value = urlParams.get('ins');
                if (urlParams.has('pmi')) inputs.pmi.value = urlParams.get('pmi');
                if (urlParams.has('hoa')) inputs.hoaFees.value = urlParams.get('hoa');
                if (urlParams.has('em')) {
                    inputs.extraMonthly.value = urlParams.get('em');
                    inputs.moreOptionsContainer.classList.remove('hidden');
                    inputs.toggleMoreOptions.textContent = '- Less Options';
                }
            }
            
            inputs.homePrice.addEventListener('input', calculate);
            inputs.downPaymentInput.addEventListener('input', calculate);
            inputs.includeTaxesCosts.addEventListener('change', calculate);
            
            const allInputs = document.querySelectorAll('input, select');
            allInputs.forEach(el => { 
                if(el.id !== 'homePrice' && el.id !== 'downPaymentInput' && el.id !== 'downPaymentType' && el.id !== 'includeTaxesCosts') { 
                    el.addEventListener('input', calculate); 
                } 
            });
            document.getElementById('calcButton').addEventListener('click', calculate);
            document.getElementById('clearButton').addEventListener('click', () => { window.location.href = window.location.pathname; });
            document.getElementById('toggleTableBtn').addEventListener('click', () => { document.getElementById('amortizationContainer').classList.remove('hidden'); });
            
            // Initial calculation
            calculate();
        });
    </script>
</body>
</html>
